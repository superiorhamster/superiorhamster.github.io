<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCMUT GPA Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .sort-header { cursor: pointer; user-select: none; transition: background 0.2s; }
        .sort-header:hover { background-color: #f1f5f9; }
        .sort-icon { display: inline-block; width: 12px; height: 12px; margin-left: 4px; vertical-align: middle; }

        /* Toggle Switch Style */
        .dot { transition: all 0.3s ease-in-out; }
        input:checked ~ .dot { transform: translateX(100%); background-color: #10b981; }
        input:checked ~ .block { background-color: #d1fae5; }

        /* Page chrome */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
        }
        .page-main {
            flex: 1 0 auto;
        }
    </style>
</head>
<body class="bg-slate-50 antialiased">
    <div id="header-placeholder"></div>
    
    <main class="page-main">
    <div class="max-w-7xl mx-auto px-4 pt-8">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">HCMUT GPA Analyzer</h1>
            <p class="text-slate-600">Ph√¢n t√≠ch b·∫£ng ƒëi·ªÉm MyBK & Qu·∫£n l√Ω k·∫ø ho·∫°ch h·ªçc t·∫≠p</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Panel: Input & Controls -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Section 1: Raw Input -->
                <div class="glass-morphism p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-semibold text-slate-700">1. D√°n b·∫£ng ƒëi·ªÉm MyBK</label>
                        <button id="btnClearRaw" class="text-xs text-red-500 hover:underline">X√≥a √¥ d√°n</button>
                    </div>
                    <textarea 
                        id="rawInput" 
                        class="w-full h-32 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-xs font-mono"
                        placeholder="D√°n n·ªôi dung t·ª´ MyBK v√†o ƒë√¢y..."
                    ></textarea>
                    <button id="btnProcessProgress" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition-all shadow-md active:scale-95 text-sm mt-3">
                        üìä Ph√¢n t√≠ch Ti·∫øn ƒë·ªô h·ªçc t·∫≠p
                    </button>
                    <p class="text-[10px] text-slate-400 mt-2 italic text-center">* Nh·∫•n n√∫t s·∫Ω x√≥a d·ªØ li·ªáu c≈© v√† ph√¢n t√≠ch l·∫°i t·ª´ ƒë·∫ßu.</p>
                </div>

                <!-- Section 2: Add Planned Course -->
                <div class="glass-morphism p-6 rounded-2xl shadow-sm border border-slate-200">
                    <label class="block text-sm font-semibold text-slate-700 mb-4">2. Th√™m m√¥n h·ªçc d·ª± ki·∫øn</label>
                    <div class="space-y-3">
                        <!-- Dropdown to select from pending courses -->
                        <div class="relative">
                            <select id="pendingCourseSelect" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500 appearance-none cursor-pointer">
                                <option value="">-- Ch·ªçn m√¥n t·ª´ CTƒêT --</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <!-- Display selected course info -->
                        <div id="selectedCourseInfo" class="hidden bg-emerald-50 border border-emerald-200 rounded-xl p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p id="selectedCourseName" class="text-sm font-medium text-emerald-700"></p>
                                    <p id="selectedCourseCode" class="text-xs text-emerald-600"></p>
                                </div>
                                <span id="selectedCourseCredits" class="text-lg font-bold text-emerald-600"></span>
                            </div>
                        </div>
                        <!-- Score input -->
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" step="0.1" min="0" max="10" id="manualScore" placeholder="ƒêi·ªÉm d·ª± ki·∫øn (0-10)" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                            <button id="btnAddManual" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl transition-all shadow-md active:scale-95 disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>
                                + Th√™m m√¥n
                            </button>
                        </div>
                        <!-- Quick add free elective -->
                        <div class="flex items-center gap-2">
                            <input type="number" step="0.1" min="0" max="10" id="freeElectiveScore" placeholder="ƒêi·ªÉm (0-10)" class="flex-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-amber-500">
                            <button id="btnAddFreeElective" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-3 rounded-lg transition-all shadow-md active:scale-95 text-xs">
                                üé≤ + T·ª± do (3TC)
                            </button>
                        </div>
                        <!-- Or manual input toggle -->
                        <details class="text-xs">
                            <summary class="text-slate-500 cursor-pointer hover:text-slate-700">‚ûï Ho·∫∑c nh·∫≠p th·ªß c√¥ng...</summary>
                            <div class="mt-2 space-y-2 p-3 bg-slate-50 rounded-lg">
                                <input type="text" id="manualName" placeholder="T√™n m√¥n h·ªçc" class="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-slate-400">
                                <input type="number" id="manualCredits" placeholder="S·ªë t√≠n ch·ªâ" class="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-slate-400">
                                <input type="number" step="0.1" id="manualScoreCustom" placeholder="ƒêi·ªÉm h·ªá 10" class="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-slate-400">
                                <button id="btnAddManualCustom" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-medium py-2 rounded-lg text-sm">
                                    Th√™m m√¥n t√πy ch·ªânh
                                </button>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Control Toggles -->
                <div class="glass-morphism p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-slate-700">Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a b·∫£ng</span>
                        <label for="toggleEdit" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="toggleEdit" class="sr-only">
                                <div class="block bg-slate-200 w-10 h-6 rounded-full"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition shadow-sm"></div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Summary Info -->
                <div class="bg-blue-50 border border-blue-100 p-5 rounded-2xl">
                    <h3 class="font-bold text-blue-800 text-sm mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        L∆∞u √Ω
                    </h3>
                    <ul class="text-[11px] text-blue-700 space-y-2 list-disc pl-4">
                        <li>N√∫t <b>Ph√¢n t√≠ch</b> s·∫Ω reset to√†n b·ªô b·∫£ng ƒë·ªÉ tr√°nh d√°n ƒë√® d·ªØ li·ªáu c≈©.</li>
                        <li>S·ª≠ d·ª•ng c·ªôt checkbox ƒë·ªÉ <b>X√≥a nhi·ªÅu</b> m√¥n c√πng l√∫c.</li>
                    </ul>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Summary Display -->
                <div id="summarySection" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="glass-morphism p-4 rounded-2xl shadow-sm border-t-4 border-indigo-500">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wider">T√≠n ch·ªâ t√≠ch l≈©y</p>
                        <p id="totalEarned" class="text-2xl font-bold text-slate-800 mt-1">0</p>
                    </div>
                    <div class="glass-morphism p-4 rounded-2xl shadow-sm border-t-4 border-blue-500">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wider">T√≠n ch·ªâ t√≠nh GPA</p>
                        <p id="totalCreditsGPA" class="text-2xl font-bold text-slate-800 mt-1">0</p>
                    </div>
                    <div class="glass-morphism p-4 rounded-2xl shadow-sm border-t-4 border-emerald-500">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wider">GPA H·ªá 4.0</p>
                        <p id="gpa4" class="text-2xl font-bold text-emerald-600 mt-1">0.00</p>
                    </div>
                    <div class="glass-morphism p-4 rounded-2xl shadow-sm border-t-4 border-orange-500">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wider">GPA H·ªá 10</p>
                        <p id="gpa10" class="text-2xl font-bold text-orange-600 mt-1">0.00</p>
                    </div>
                </div>

                <!-- Data Table Control -->
                <div class="flex justify-between items-center px-2">
                    <div id="bulkActions" class="flex gap-2 invisible">
                        <button id="btnDeleteSelected" class="flex items-center text-xs bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-100 transition-all font-semibold shadow-sm">
                            <svg class="w-3.5 h-3.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Xo√° m·ª•c ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    <button id="btnExportCSV" class="flex items-center text-xs bg-white border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 transition-all font-medium text-slate-600 shadow-sm">
                        <svg class="w-3.5 h-3.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Xu·∫•t CSV (.csv)
                    </button>
                </div>

                <!-- Data Table -->
                <div class="glass-morphism rounded-2xl shadow-sm overflow-hidden border border-slate-200">
                    <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-sm border-collapse" id="mainTable">
                            <thead class="sticky top-0 bg-slate-100 text-slate-600 font-semibold uppercase text-xs z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-4 w-10 text-center">
                                        <input type="checkbox" id="selectAll" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                    </th>
                                    <th class="px-4 py-4 sort-header" onclick="toggleSort('name')">
                                        M√¥n h·ªçc <span id="icon-name" class="sort-icon text-[10px]">‚Üï</span>
                                    </th>
                                    <th class="px-2 py-4 text-center sort-header" onclick="toggleSort('credits')">
                                        TC <span id="icon-credits" class="sort-icon text-[10px]">‚Üï</span>
                                    </th>
                                    <th class="px-2 py-4 text-center sort-header" onclick="toggleSort('score10')">
                                        H·ªá 10 <span id="icon-score10" class="sort-icon text-[10px]">‚Üï</span>
                                    </th>
                                    <th class="px-2 py-4 text-center sort-header" onclick="toggleSort('score4')">
                                        H·ªá 4 <span id="icon-score4" class="sort-icon text-[10px]">‚Üï</span>
                                    </th>
                                    <th class="px-4 py-4 text-center">Xo√°</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody" class="divide-y divide-slate-100 bg-white text-xs">
                                <tr>
                                    <td colspan="6" class="px-6 py-12 text-center text-slate-400 italic text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc t·∫≠p</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- GPA Target Calculator Section -->
                <div id="gpaCalculatorSection" class="glass-morphism rounded-2xl shadow-sm border border-slate-200 p-6 hidden">
                    <h3 class="font-bold text-slate-800 text-base mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        üéØ T√≠nh to√°n GPA M·ª•c ti√™u
                    </h3>
                    
                    <!-- Target GPA Selection -->
                    <div class="mb-4">
                        <label class="text-sm font-medium text-slate-600 mb-2 block">Ch·ªçn GPA m·ª•c ti√™u (H·ªá 4):</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setTargetGPA(2.5)" class="target-btn px-4 py-2 rounded-lg text-sm font-semibold border-2 border-slate-200 hover:border-yellow-400 hover:bg-yellow-50 transition-all" data-target="2.5">
                                2.5 <span class="text-[10px] text-slate-400">(Kh√°)</span>
                            </button>
                            <button onclick="setTargetGPA(3.2)" class="target-btn px-4 py-2 rounded-lg text-sm font-semibold border-2 border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition-all" data-target="3.2">
                                3.2 <span class="text-[10px] text-slate-400">(Gi·ªèi)</span>
                            </button>
                            <button onclick="setTargetGPA(3.6)" class="target-btn px-4 py-2 rounded-lg text-sm font-semibold border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 transition-all" data-target="3.6">
                                3.6 <span class="text-[10px] text-slate-400">(Xu·∫•t s·∫Øc)</span>
                            </button>
                            <div class="flex items-center gap-2">
                                <input type="number" step="0.01" min="0" max="4" id="customTargetGPA" placeholder="Tu·ª≥ ch·ªçn" class="w-24 px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                                <button onclick="setCustomTargetGPA()" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold hover:bg-purple-700 transition-all">ƒê·∫∑t</button>
                            </div>
                        </div>
                    </div>

                    <!-- Course Groups Summary -->
                    <div id="courseGroupsSummary" class="mb-4 hidden">
                        <label class="text-sm font-medium text-slate-600 mb-2 block">üìä T·ªïng quan t√≠n ch·ªâ theo nh√≥m:</label>
                        <div id="courseGroupsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-[200px] overflow-y-auto custom-scrollbar">
                        </div>
                    </div>

                    <!-- Analysis Result -->
                    <div id="gpaAnalysisResult" class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-100 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-[10px] font-medium text-slate-500 uppercase">GPA Hi·ªán t·∫°i</p>
                                <p id="currentGPADisplay" class="text-xl font-bold text-slate-700">0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] font-medium text-slate-500 uppercase">GPA M·ª•c ti√™u</p>
                                <p id="targetGPADisplay" class="text-xl font-bold text-purple-600">0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] font-medium text-slate-500 uppercase">ƒêi·ªÉm TB c·∫ßn ƒë·∫°t</p>
                                <p id="requiredAvgDisplay" class="text-xl font-bold text-emerald-600">-</p>
                            </div>
                        </div>
                        <div id="gpaAnalysisMessage" class="text-sm text-slate-600 mb-4"></div>
                    </div>

                    <!-- Pending Courses Selection -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium text-slate-600">M√¥n h·ªçc ch∆∞a ho√†n th√†nh (<span id="pendingCount">0</span> m√¥n - <span id="pendingCredits">0</span> TC):</label>
                            <div class="flex gap-2">
                                <button onclick="selectAllPending()" class="text-xs text-blue-600 hover:underline">Ch·ªçn t·∫•t c·∫£</button>
                                <button onclick="deselectAllPending()" class="text-xs text-slate-500 hover:underline">B·ªè ch·ªçn</button>
                            </div>
                        </div>
                        <div id="pendingCoursesGrid" class="max-h-[300px] overflow-y-auto custom-scrollbar border border-slate-200 rounded-xl">
                            <table class="w-full text-left text-xs">
                                <thead class="sticky top-0 bg-slate-100 text-slate-600 font-semibold uppercase text-[10px]">
                                    <tr>
                                        <th class="px-3 py-2 w-8 text-center">
                                            <input type="checkbox" id="selectAllPending" class="rounded border-slate-300 text-purple-600">
                                        </th>
                                        <th class="px-3 py-2">M√£ MH</th>
                                        <th class="px-3 py-2">T√™n m√¥n h·ªçc</th>
                                        <th class="px-3 py-2 text-center">TC</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingCoursesBody" class="divide-y divide-slate-100 bg-white">
                                    <tr><td colspan="4" class="px-4 py-8 text-center text-slate-400 italic">Ch∆∞a c√≥ d·ªØ li·ªáu m√¥n ch∆∞a h·ªçc</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 italic">‚ÑπÔ∏è Ch·ªçn c√°c m√¥n b·∫°n d·ª± ƒë·ªãnh h·ªçc ƒë·ªÉ t√≠nh ƒëi·ªÉm trung b√¨nh c·∫ßn ƒë·∫°t.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // State management
        let extractedCourses = [];
        let manualCourses = [];
        let pendingCourses = []; // M√¥n ch∆∞a h·ªçc (t·ª´ Ti·∫øn ƒë·ªô h·ªçc t·∫≠p)
        let courseGroups = []; // Nh√≥m m√¥n h·ªçc v√† t√≠n ch·ªâ y√™u c·∫ßu
        let selectedIds = new Set();
        let selectedPendingIds = new Set();
        let currentSort = { column: null, direction: 'asc' };
        let tempCounter = 1;
        let isEditMode = false;

        const gradeMap = {
            'A+': 4.0, 'A': 4.0, 'B+': 3.5, 'B': 3.0,
            'C+': 2.5, 'C': 2.0, 'D+': 1.5, 'D': 1.0, 'F': 0.0
        };

        function getGradeLetter(score10) {
            if (score10 > 10) return null;
            if (score10 >= 8.5) return 'A';
            if (score10 >= 8.0) return 'B+';
            if (score10 >= 7.0) return 'B';
            if (score10 >= 6.5) return 'C+';
            if (score10 >= 5.5) return 'C';
            if (score10 >= 5.0) return 'D+';
            if (score10 >= 4.0) return 'D';
            return 'F';
        }

        function calculateScore4(score10, letter) {
            if (letter && gradeMap[letter] !== undefined) return gradeMap[letter];
            if (score10 === null || score10 > 10) return null;
            const derivedLetter = getGradeLetter(score10);
            return gradeMap[derivedLetter] ?? null;
        }

        // Parser for "Ti·∫øn ƒë·ªô h·ªçc t·∫≠p" page
        function parseProgressData(text) {
            const courses = [];
            const pending = [];
            const groups = [];
            
            // Parse course groups first: "T√™n nh√≥m X/Y Kh·ªëi ki·∫øn th·ª©c B·∫Øt bu·ªôc/T·ª± ch·ªçn"
            // Pattern: T√™n nh√≥m (kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng s·ªë) + X/Y + Kh·ªëi ki·∫øn th·ª©c
            const groupPattern = /^([^\d\n][^\n]*?)\s+(\d+)\/(\d+)\s+Kh·ªëi ki·∫øn th·ª©c\s*(B·∫Øt bu·ªôc|T·ª± ch·ªçn)/gm;
            let groupMatch;
            while ((groupMatch = groupPattern.exec(text)) !== null) {
                groups.push({
                    id: 'grp-' + Math.random().toString(36).substr(2, 9),
                    name: groupMatch[1].trim(),
                    earned: parseInt(groupMatch[2]),
                    required: parseInt(groupMatch[3]),
                    type: groupMatch[4], // B·∫Øt bu·ªôc / T·ª± ch·ªçn
                    remaining: parseInt(groupMatch[3]) - parseInt(groupMatch[2])
                });
            }
            courseGroups = groups;
            
            // Format: STT | M√£ MH | T√™n m√¥n h·ªçc | ƒêi·ªÉm s·ªë | ƒêi·ªÉm ch·ªØ | T√≠n ch·ªâ | ƒê·∫°t | Ghi ch√∫
            // ƒêi·ªÉm s·ªë: s·ªë th·ª±c (6.4), 12 (mi·ªÖn), 21 (ƒë·∫°t), ho·∫∑c -- (ch∆∞a h·ªçc)
            // ƒêi·ªÉm ch·ªØ: A+, A, B+, B, C+, C, D+, D, F ho·∫∑c --
            // M√£ m√¥n c√≥ th·ªÉ c√≥ kho·∫£ng tr·∫Øng ·ªü ƒë·∫ßu
            const rowPattern = /(\d+)\s+([A-Z]{2,}\d{4})\s+(.+?)\s+(\d+(?:\.\d+)?|--)\s+([A-F][+]?|--)\s+(\d+)/g;
            
            let match;
            while ((match = rowPattern.exec(text)) !== null) {
                const courseCode = match[2].trim();
                const name = match[3].trim();
                let score10Str = match[4];
                let gradeLetterStr = match[5];
                const credits = parseInt(match[6]);

                // M√¥n ch∆∞a h·ªçc (--) -> th√™m v√†o pending
                if (score10Str === '--' && gradeLetterStr === '--') {
                    pending.push({
                        id: 'pend-' + Math.random().toString(36).substr(2, 9),
                        courseCode,
                        name,
                        credits,
                        type: 'pending'
                    });
                    continue;
                }

                let score10 = null;
                let gradeLetter = null;
                let score4 = null;

                // X·ª≠ l√Ω ƒëi·ªÉm s·ªë
                if (score10Str !== '--') {
                    const scoreNum = parseFloat(score10Str);
                    
                    if (scoreNum === 12) {
                        // ƒêi·ªÉm 12 = Mi·ªÖn (MT)
                        gradeLetter = 'MT';
                        score4 = null;
                    } else if (scoreNum === 21) {
                        // ƒêi·ªÉm 21 = ƒê·∫°t (DT) 
                        gradeLetter = 'DT';
                        score4 = null;
                    } else {
                        // ƒêi·ªÉm b√¨nh th∆∞·ªùng
                        score10 = scoreNum;
                        gradeLetter = gradeLetterStr !== '--' ? gradeLetterStr : getGradeLetter(score10);
                        score4 = calculateScore4(score10, gradeLetter);
                    }
                }

                courses.push({
                    id: 'ext-' + Math.random().toString(36).substr(2, 9),
                    courseCode,
                    name,
                    credits,
                    score10,
                    gradeLetter,
                    score4,
                    type: 'extracted',
                    hidden: false
                });
            }
            
            // Store pending courses globally
            pendingCourses = pending;
            
            // Filter duplicates: keep only the best score for each course code
            return filterDuplicateCourses(courses);
        }

        function filterDuplicateCourses(courses) {
            // Group courses by course code
            const courseGroups = {};
            courses.forEach(course => {
                if (!courseGroups[course.courseCode]) {
                    courseGroups[course.courseCode] = [];
                }
                courseGroups[course.courseCode].push(course);
            });

            // For each group, mark lower-scoring duplicates as hidden
            Object.values(courseGroups).forEach(group => {
                if (group.length > 1) {
                    // Sort by score (best first): F grades go last, then by score10 descending
                    group.sort((a, b) => {
                        // Failed courses (F) should be ranked lower
                        const aFailed = a.gradeLetter === 'F';
                        const bFailed = b.gradeLetter === 'F';
                        if (aFailed && !bFailed) return 1;
                        if (!aFailed && bFailed) return -1;
                        
                        // MT/DT courses: treat as lower priority than graded courses
                        const aMTDT = a.gradeLetter === 'MT' || a.gradeLetter === 'DT';
                        const bMTDT = b.gradeLetter === 'MT' || b.gradeLetter === 'DT';
                        if (aMTDT && !bMTDT) return 1;
                        if (!aMTDT && bMTDT) return -1;
                        
                        // Compare by score10 (higher is better)
                        const scoreA = a.score10 ?? -1;
                        const scoreB = b.score10 ?? -1;
                        return scoreB - scoreA;
                    });
                    
                    // Mark all except the best one as hidden
                    for (let i = 1; i < group.length; i++) {
                        group[i].hidden = true;
                    }
                }
            });

            return courses;
        }

        window.toggleSort = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            updateSortIcons();
            updateUI();
        };

        function updateSortIcons() {
            const columns = ['name', 'credits', 'score10', 'score4'];
            columns.forEach(col => {
                const icon = document.getElementById(`icon-${col}`);
                if (currentSort.column === col) {
                    icon.innerText = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                    icon.classList.add('text-blue-600');
                } else {
                    icon.innerText = '‚Üï';
                    icon.classList.remove('text-blue-600');
                }
            });
        }

        function updateField(id, field, value) {
            const updateCourse = (c) => {
                if (c.id === id) {
                    if (field === 'credits') c.credits = parseInt(value) || 0;
                    if (field === 'score10') {
                        c.score10 = value === '' ? null : parseFloat(value);
                        // Ch·ªâ t√≠nh l·∫°i ƒëi·ªÉm 4 n·∫øu kh√¥ng ph·∫£i m√¥n MT/DT (gi·ªØ nguy√™n t√≠nh ch·∫•t m√¥n mi·ªÖn/ƒë·∫°t)
                        if (c.gradeLetter !== 'MT' && c.gradeLetter !== 'DT') {
                            c.score4 = calculateScore4(c.score10, null);
                            c.gradeLetter = getGradeLetter(c.score10);
                        } else {
                            c.score4 = null; // M√¥n MT/DT kh√¥ng c√≥ ƒëi·ªÉm 4 s·ªë
                        }
                    }
                }
                return c;
            };
            extractedCourses = extractedCourses.map(updateCourse);
            manualCourses = manualCourses.map(updateCourse);
            updateUI(false);
            // Recalculate GPA target if set
            if (typeof currentTargetGPA !== 'undefined' && currentTargetGPA) calculateGPATarget(currentTargetGPA);
        }

        function updateUI(resetSelections = true) {
            // Filter out hidden courses (duplicates with lower scores)
            let allCourses = [...extractedCourses, ...manualCourses].filter(c => !c.hidden);
            const resultBody = document.getElementById('resultBody');
            
            if (resetSelections) {
                selectedIds.clear();
                document.getElementById('selectAll').checked = false;
            }

            // S·∫Øp x·∫øp
            if (currentSort.column) {
                allCourses.sort((a, b) => {
                    let valA = a[currentSort.column];
                    let valB = b[currentSort.column];
                    const isAInvalid = (currentSort.column.includes('score') && (valA === null || valA > 10));
                    const isBInvalid = (currentSort.column.includes('score') && (valB === null || valB > 10));
                    if (isAInvalid && !isBInvalid) return 1;
                    if (!isAInvalid && isBInvalid) return -1;
                    if (isAInvalid && isBInvalid) return 0;
                    if (typeof valA === 'string') {
                        return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    } else {
                        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                    }
                });
            }

            resultBody.innerHTML = '';

            if (allCourses.length === 0) {
                resultBody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 italic text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc t·∫≠p</td></tr>`;
                ['totalEarned', 'totalCreditsGPA', 'gpa4', 'gpa10'].forEach(id => document.getElementById(id).innerText = (id.includes('gpa') ? '0.00' : '0'));
                updateBulkActionVisibility();
                return;
            }

            let totalEarnedCredits = 0;
            let totalGPACredits = 0;
            let sumWeighted4 = 0;
            let sumWeighted10 = 0;

            allCourses.forEach(c => {
                if (c.credits >= 0 && c.gradeLetter !== 'F') totalEarnedCredits += c.credits;
                const isGPAEligible = c.credits > 0 && c.gradeLetter !== 'MT' && c.gradeLetter !== 'DT' && c.score4 !== null && (c.score10 === null || c.score10 <= 10);
                if (isGPAEligible) {
                    totalGPACredits += c.credits;
                    sumWeighted4 += (c.score4 * c.credits);
                    if (c.score10 !== null) sumWeighted10 += (c.score10 * c.credits);
                }

                const row = document.createElement('tr');
                const isManual = c.type === 'manual';
                const isScoreWarning = c.score10 > 10;
                row.className = isManual ? "bg-emerald-50/40" : (isGPAEligible ? "hover:bg-slate-50 transition-colors" : "bg-slate-50/70 opacity-70");
                
                const checkboxHtml = `<input type="checkbox" class="row-checkbox rounded border-slate-300 text-blue-600" data-id="${c.id}" ${selectedIds.has(c.id) ? 'checked' : ''}>`;
                
                const creditsCell = isEditMode ? 
                    `<input type="number" class="w-12 p-1 border rounded text-center" value="${c.credits}" onchange="updateField('${c.id}', 'credits', this.value)">` : 
                    c.credits;

                const score10Cell = isEditMode && (c.gradeLetter !== 'MT' && c.gradeLetter !== 'DT') ? 
                    `<input type="number" step="0.1" class="w-16 p-1 border rounded text-center" value="${c.score10 ?? ''}" onchange="updateField('${c.id}', 'score10', this.value)">` : 
                    `${c.score10 !== null ? c.score10.toFixed(1) : (c.gradeLetter || '-')}${isScoreWarning ? '*' : ''}`;

                row.innerHTML = `
                    <td class="px-4 py-3 text-center">${checkboxHtml}</td>
                    <td class="px-4 py-3">
                        <div class="font-medium ${isManual ? 'text-emerald-700' : 'text-slate-700'} truncate max-w-[200px]" title="${c.name}">${c.name}</div>
                        <div class="text-[9px] uppercase font-bold text-slate-400 tracking-tighter">${isManual ? 'D·ª± ki·∫øn' : 'Ch√≠nh th·ª©c'}</div>
                    </td>
                    <td class="px-2 py-3 text-center text-slate-600 font-medium">${creditsCell}</td>
                    <td class="px-2 py-3 text-center font-semibold ${isScoreWarning ? 'text-red-400' : ''}">${score10Cell}</td>
                    <td class="px-2 py-3 text-center font-bold text-blue-600">${c.score4 !== null ? c.score4.toFixed(1) : '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteCourse('${c.id}', '${c.type}')" class="p-1.5 text-slate-300 hover:text-red-500 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                resultBody.appendChild(row);
            });

            document.getElementById('totalEarned').innerText = totalEarnedCredits;
            document.getElementById('totalCreditsGPA').innerText = totalGPACredits;
            document.getElementById('gpa4').innerText = (totalGPACredits > 0 ? (sumWeighted4 / totalGPACredits) : 0).toFixed(2);
            document.getElementById('gpa10').innerText = (totalGPACredits > 0 ? (sumWeighted10 / totalGPACredits) : 0).toFixed(2);
            
            bindCheckboxes();
            updateBulkActionVisibility();
        }

        function bindCheckboxes() {
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) selectedIds.add(id);
                    else {
                        selectedIds.delete(id);
                        document.getElementById('selectAll').checked = false;
                    }
                    updateBulkActionVisibility();
                });
            });
        }

        function updateBulkActionVisibility() {
            const bulkActions = document.getElementById('bulkActions');
            const countEl = document.getElementById('selectedCount');
            if (selectedIds.size > 0) {
                bulkActions.classList.remove('invisible');
                countEl.innerText = selectedIds.size;
            } else {
                bulkActions.classList.add('invisible');
            }
        }

        // Export to CSV
        function exportToCSV() {
            const allCourses = [...extractedCourses, ...manualCourses];
            if (allCourses.length === 0) return;
            let csvContent = "\ufeffLoai,Ten Mon Hoc,Tin Chi,Diem He 10,Diem He 4\n";
            allCourses.forEach(c => {
                const type = c.type === 'manual' ? "Du kien" : "Chinh thuc";
                const s10 = c.score10 !== null ? c.score10 : (c.gradeLetter || "-");
                const s4 = c.score4 !== null ? c.score4 : "-";
                csvContent += `"${type}","${c.name.replace(/"/g, '""')}",${c.credits},"${s10}",${s4}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `GPA_Export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Event Listeners
        document.getElementById('btnProcessProgress').addEventListener('click', () => {
            const text = document.getElementById('rawInput').value;
            if (!text) return;
            
            // RESET: L√†m s·∫°ch danh s√°ch tr∆∞·ªõc khi th√™m m·ªõi
            extractedCourses = parseProgressData(text);
            manualCourses = []; // X√≥a lu√¥n c·∫£ c√°c m√¥n d·ª± t√≠nh n·∫øu mu·ªën reset ho√†n to√†n
            
            selectedIds.clear();
            selectedPendingIds.clear();
            updateUI();
            updatePendingCoursesUI();
            updatePendingCourseDropdown();
        });

        // Update pending course dropdown
        function updatePendingCourseDropdown() {
            const select = document.getElementById('pendingCourseSelect');
            const btn = document.getElementById('btnAddManual');
            
            select.innerHTML = '<option value="">-- Ch·ªçn m√¥n t·ª´ CTƒêT --</option>';
            
            if (pendingCourses.length === 0) {
                select.innerHTML = '<option value="">-- Kh√¥ng c√≥ m√¥n n√†o --</option>';
                btn.disabled = true;
                return;
            }
            
            pendingCourses.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = `${c.courseCode} - ${c.name} (${c.credits} TC)`;
                option.dataset.name = c.name;
                option.dataset.code = c.courseCode;
                option.dataset.credits = c.credits;
                select.appendChild(option);
            });
        }

        // Handle dropdown selection change
        document.getElementById('pendingCourseSelect').addEventListener('change', (e) => {
            const selectedOption = e.target.selectedOptions[0];
            const infoDiv = document.getElementById('selectedCourseInfo');
            const btn = document.getElementById('btnAddManual');
            
            if (e.target.value && selectedOption.dataset.name) {
                document.getElementById('selectedCourseName').textContent = selectedOption.dataset.name;
                document.getElementById('selectedCourseCode').textContent = selectedOption.dataset.code;
                document.getElementById('selectedCourseCredits').textContent = selectedOption.dataset.credits + ' TC';
                infoDiv.classList.remove('hidden');
                btn.disabled = false;
            } else {
                infoDiv.classList.add('hidden');
                btn.disabled = true;
            }
        });

        // Add course from pending list
        document.getElementById('btnAddManual').addEventListener('click', () => {
            const select = document.getElementById('pendingCourseSelect');
            const selectedId = select.value;
            const score = parseFloat(document.getElementById('manualScore').value);
            
            if (!selectedId) return;
            if (isNaN(score) || score < 0 || score > 10) {
                alert('Vui l√≤ng nh·∫≠p ƒëi·ªÉm d·ª± ki·∫øn t·ª´ 0 ƒë·∫øn 10');
                return;
            }
            
            // Find the pending course
            const pendingCourse = pendingCourses.find(c => c.id === selectedId);
            if (!pendingCourse) return;
            
            // Add to manual courses (as planned course)
            manualCourses.push({
                id: 'man-' + Date.now(),
                courseCode: pendingCourse.courseCode,
                name: pendingCourse.name,
                credits: pendingCourse.credits,
                score10: score,
                gradeLetter: getGradeLetter(score),
                score4: calculateScore4(score, null),
                type: 'manual'
            });
            
            // Remove from pending courses
            pendingCourses = pendingCourses.filter(c => c.id !== selectedId);
            selectedPendingIds.delete(selectedId);
            
            // Update all UIs
            updateUI();
            updatePendingCoursesUI();
            updatePendingCourseDropdown();
            
            // Reset form
            select.value = '';
            document.getElementById('manualScore').value = '';
            document.getElementById('selectedCourseInfo').classList.add('hidden');
            document.getElementById('btnAddManual').disabled = true;
            
            // Recalculate GPA target if set
            if (currentTargetGPA) calculateGPATarget(currentTargetGPA);
        });

        // Add custom manual course
        document.getElementById('btnAddManualCustom').addEventListener('click', () => {
            let name = document.getElementById('manualName').value.trim() || `temp${tempCounter++}`;
            const credits = parseInt(document.getElementById('manualCredits').value);
            const score = parseFloat(document.getElementById('manualScoreCustom').value);
            
            if (isNaN(credits) || credits <= 0) {
                alert('Vui l√≤ng nh·∫≠p s·ªë t√≠n ch·ªâ h·ª£p l·ªá');
                return;
            }
            if (isNaN(score) || score < 0 || score > 10) {
                alert('Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10');
                return;
            }

            manualCourses.push({
                id: 'man-' + Date.now(),
                name, credits, score10: score,
                gradeLetter: getGradeLetter(score),
                score4: calculateScore4(score, null),
                type: 'manual'
            });
            updateUI();
            ['manualName', 'manualCredits', 'manualScoreCustom'].forEach(id => document.getElementById(id).value = '');
            
            // Recalculate GPA target if set
            if (currentTargetGPA) calculateGPATarget(currentTargetGPA);
        });

        // Add free elective course (T·ª± do)
        let freeElectiveCounter = 1;
        document.getElementById('btnAddFreeElective').addEventListener('click', () => {
            const score = parseFloat(document.getElementById('freeElectiveScore').value);
            
            if (isNaN(score) || score < 0 || score > 10) {
                alert('Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10');
                return;
            }

            manualCourses.push({
                id: 'free-' + Date.now(),
                courseCode: 'TUDO' + freeElectiveCounter.toString().padStart(4, '0'),
                name: `T·ª± do #${freeElectiveCounter}`,
                credits: 3,
                score10: score,
                gradeLetter: getGradeLetter(score),
                score4: calculateScore4(score, null),
                type: 'manual',
                isFreeElective: true // Flag to identify free elective courses
            });
            freeElectiveCounter++;
            updateUI();
            document.getElementById('freeElectiveScore').value = '';
            
            // Recalculate GPA target if set
            if (currentTargetGPA) calculateGPATarget(currentTargetGPA);
        });

        document.getElementById('toggleEdit').addEventListener('change', (e) => {
            isEditMode = e.target.checked;
            updateUI(false);
        });

        document.getElementById('selectAll').addEventListener('change', (e) => {
            const allIds = [...extractedCourses, ...manualCourses].map(c => c.id);
            if (e.target.checked) allIds.forEach(id => selectedIds.add(id));
            else selectedIds.clear();
            updateUI(false);
        });

        document.getElementById('btnDeleteSelected').addEventListener('click', () => {
            // Return manual courses with courseCode back to pending
            manualCourses.forEach(c => {
                if (selectedIds.has(c.id) && c.courseCode) {
                    pendingCourses.push({
                        id: 'pend-' + Math.random().toString(36).substr(2, 9),
                        courseCode: c.courseCode,
                        name: c.name,
                        credits: c.credits,
                        type: 'pending'
                    });
                }
            });
            
            extractedCourses = extractedCourses.filter(c => !selectedIds.has(c.id));
            manualCourses = manualCourses.filter(c => !selectedIds.has(c.id));
            selectedIds.clear();
            updateUI();
            updatePendingCoursesUI();
            updatePendingCourseDropdown();
            // Recalculate GPA target if set
            if (currentTargetGPA) calculateGPATarget(currentTargetGPA);
        });

        window.deleteCourse = (id, type) => {
            if (type === 'manual') {
                // Find the course being deleted
                const deletedCourse = manualCourses.find(c => c.id === id);
                
                // If it has a courseCode, return it to pending courses
                if (deletedCourse && deletedCourse.courseCode) {
                    pendingCourses.push({
                        id: 'pend-' + Math.random().toString(36).substr(2, 9),
                        courseCode: deletedCourse.courseCode,
                        name: deletedCourse.name,
                        credits: deletedCourse.credits,
                        type: 'pending'
                    });
                }
                
                manualCourses = manualCourses.filter(c => c.id !== id);
            } else {
                extractedCourses = extractedCourses.filter(c => c.id !== id);
            }
            selectedIds.delete(id);
            updateUI(false);
            updatePendingCoursesUI();
            updatePendingCourseDropdown();
            // Recalculate GPA target if set
            if (currentTargetGPA) calculateGPATarget(currentTargetGPA);
        };

        document.getElementById('btnClearRaw').addEventListener('click', () => {
            document.getElementById('rawInput').value = '';
        });

        document.getElementById('btnExportCSV').addEventListener('click', exportToCSV);

        // ===== GPA TARGET CALCULATOR FUNCTIONS =====
        let currentTargetGPA = null;

        function updateCourseGroupsUI() {
            const container = document.getElementById('courseGroupsGrid');
            const section = document.getElementById('courseGroupsSummary');
            
            if (courseGroups.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            container.innerHTML = '';
            
            // Calculate free elective credits from manual courses
            const freeElectiveCredits = manualCourses
                .filter(c => c.isFreeElective && !c.hidden)
                .reduce((sum, c) => sum + c.credits, 0);
            
            // Calculate totals
            let totalEarned = 0;
            let totalRequired = 0;
            
            courseGroups.forEach(g => {
                // Add free elective credits to "T·ª± ch·ªçn b·ªï sung / t·ª± do" group
                let adjustedEarned = g.earned;
                let isFreeElectiveGroup = g.name.toLowerCase().includes('t·ª± do') || 
                                          g.name.toLowerCase().includes('b·ªï sung');
                
                if (isFreeElectiveGroup) {
                    adjustedEarned = Math.min(g.required, g.earned + freeElectiveCredits);
                }
                
                totalEarned += adjustedEarned;
                totalRequired += g.required;
                
                const remaining = g.required - adjustedEarned;
                const isComplete = remaining <= 0;
                const progressPercent = Math.min(100, (adjustedEarned / g.required) * 100);
                
                const card = document.createElement('div');
                card.className = `p-3 rounded-lg border ${isComplete ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-200'}`;
                
                // Show additional info for free elective group
                const freeElectiveInfo = isFreeElectiveGroup && freeElectiveCredits > 0 
                    ? `<span class="text-[10px] text-amber-600 ml-1">(+${freeElectiveCredits} TC t·ª± do)</span>` 
                    : '';
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-medium ${isComplete ? 'text-emerald-700' : 'text-slate-700'} truncate max-w-[180px]" title="${g.name}">
                            ${isComplete ? '‚úÖ' : 'üìö'} ${g.name}
                        </span>
                        <span class="text-xs font-bold ${isComplete ? 'text-emerald-600' : 'text-slate-600'}">${adjustedEarned}/${g.required}${freeElectiveInfo}</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-1.5">
                        <div class="h-1.5 rounded-full ${isComplete ? 'bg-emerald-500' : 'bg-blue-500'}" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="flex justify-between mt-1">
                        <span class="text-[10px] ${g.type === 'B·∫Øt bu·ªôc' ? 'text-red-500' : 'text-blue-500'}">${g.type}</span>
                        <span class="text-[10px] ${isComplete ? 'text-emerald-600' : 'text-amber-600'}">
                            ${isComplete ? 'Ho√†n th√†nh' : `C√≤n ${remaining} TC`}
                        </span>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Add total summary card
            const totalCard = document.createElement('div');
            const totalRemaining = totalRequired - totalEarned;
            totalCard.className = 'p-3 rounded-lg border-2 border-indigo-300 bg-indigo-50 md:col-span-2';
            totalCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-indigo-700">üìä T·ªîNG C·ªòNG</span>
                    <span class="text-sm font-bold text-indigo-700">${totalEarned}/${totalRequired} TC</span>
                </div>
                <div class="w-full bg-indigo-200 rounded-full h-2 mt-2">
                    <div class="h-2 rounded-full bg-indigo-500" style="width: ${Math.min(100, (totalEarned / totalRequired) * 100)}%"></div>
                </div>
                <p class="text-xs text-indigo-600 mt-1 text-center">C√≤n <b>${totalRemaining}</b> t√≠n ch·ªâ n·ªØa ƒë·ªÉ ho√†n th√†nh CTƒêT</p>
            `;
            container.appendChild(totalCard);
        }

        function updatePendingCoursesUI() {
            const container = document.getElementById('pendingCoursesBody');
            const section = document.getElementById('gpaCalculatorSection');
            
            // Always show section if we have course groups or pending courses
            if (pendingCourses.length === 0 && courseGroups.length === 0) {
                section.classList.add('hidden');
                container.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400 italic">Ch∆∞a c√≥ d·ªØ li·ªáu m√¥n ch∆∞a h·ªçc</td></tr>';
                return;
            }
            
            section.classList.remove('hidden');
            updateCourseGroupsUI();
            
            if (pendingCourses.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400 italic">Kh√¥ng c√≥ m√¥n ch∆∞a h·ªçc</td></tr>';
                return;
            }
            
            const totalPendingCredits = pendingCourses.reduce((sum, c) => sum + c.credits, 0);
            document.getElementById('pendingCount').innerText = pendingCourses.length;
            document.getElementById('pendingCredits').innerText = totalPendingCredits;
            
            container.innerHTML = '';
            pendingCourses.forEach(c => {
                const row = document.createElement('tr');
                row.className = selectedPendingIds.has(c.id) ? 'bg-purple-50' : 'hover:bg-slate-50';
                row.innerHTML = `
                    <td class="px-3 py-2 text-center">
                        <input type="checkbox" class="pending-checkbox rounded border-slate-300 text-purple-600" data-id="${c.id}" ${selectedPendingIds.has(c.id) ? 'checked' : ''}>
                    </td>
                    <td class="px-3 py-2 font-mono text-slate-600">${c.courseCode}</td>
                    <td class="px-3 py-2 text-slate-700 truncate max-w-[200px]" title="${c.name}">${c.name}</td>
                    <td class="px-3 py-2 text-center font-medium text-slate-600">${c.credits}</td>
                `;
                container.appendChild(row);
            });
            
            bindPendingCheckboxes();
            if (currentTargetGPA) calculateGPATarget(currentTargetGPA);
        }

        function bindPendingCheckboxes() {
            document.querySelectorAll('.pending-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) selectedPendingIds.add(id);
                    else {
                        selectedPendingIds.delete(id);
                        document.getElementById('selectAllPending').checked = false;
                    }
                    updatePendingCoursesUI();
                });
            });
        }

        document.getElementById('selectAllPending').addEventListener('change', (e) => {
            if (e.target.checked) pendingCourses.forEach(c => selectedPendingIds.add(c.id));
            else selectedPendingIds.clear();
            updatePendingCoursesUI();
        });

        window.selectAllPending = () => {
            pendingCourses.forEach(c => selectedPendingIds.add(c.id));
            document.getElementById('selectAllPending').checked = true;
            updatePendingCoursesUI();
        };

        window.deselectAllPending = () => {
            selectedPendingIds.clear();
            document.getElementById('selectAllPending').checked = false;
            updatePendingCoursesUI();
        };

        window.setTargetGPA = (target) => {
            currentTargetGPA = target;
            // Update button styles
            document.querySelectorAll('.target-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-100', 'text-purple-700');
                if (parseFloat(btn.dataset.target) === target) {
                    btn.classList.add('border-purple-500', 'bg-purple-100', 'text-purple-700');
                }
            });
            document.getElementById('customTargetGPA').value = '';
            calculateGPATarget(target);
        };

        window.setCustomTargetGPA = () => {
            const customValue = parseFloat(document.getElementById('customTargetGPA').value);
            if (isNaN(customValue) || customValue < 0 || customValue > 4) {
                alert('Vui l√≤ng nh·∫≠p GPA t·ª´ 0 ƒë·∫øn 4');
                return;
            }
            currentTargetGPA = customValue;
            document.querySelectorAll('.target-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-100', 'text-purple-700');
            });
            calculateGPATarget(customValue);
        };

        function calculateGPATarget(targetGPA) {
            const resultDiv = document.getElementById('gpaAnalysisResult');
            const messageDiv = document.getElementById('gpaAnalysisMessage');
            resultDiv.classList.remove('hidden');
            
            // Get current GPA from the main display (synced with gpa4)
            const currentGPA = parseFloat(document.getElementById('gpa4').innerText) || 0;
            const currentCredits = parseInt(document.getElementById('totalCreditsGPA').innerText) || 0;
            const currentWeightedSum = currentGPA * currentCredits;
            
            // Get selected pending courses
            const selectedPending = pendingCourses.filter(c => selectedPendingIds.has(c.id));
            const pendingCreditsSelected = selectedPending.reduce((sum, c) => sum + c.credits, 0);
            
            document.getElementById('currentGPADisplay').innerText = currentGPA.toFixed(2);
            document.getElementById('targetGPADisplay').innerText = targetGPA.toFixed(2);
            
            if (selectedPending.length === 0) {
                document.getElementById('requiredAvgDisplay').innerText = '-';
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-2 text-amber-700 bg-amber-50 p-3 rounded-lg">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        <span>Vui l√≤ng ch·ªçn c√°c m√¥n d·ª± ƒë·ªãnh h·ªçc ·ªü b·∫£ng b√™n d∆∞·ªõi ƒë·ªÉ t√≠nh to√°n.</span>
                    </div>
                `;
                return;
            }
            
            // === LOGIC L√ÄM TR√íN ===
            // GPA ƒë∆∞·ª£c l√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n (VD: 3.16 ‚Üí 3.2)
            // V√† tr∆∞·ªõc ƒë√≥ c√≥ th·ªÉ ƒë∆∞·ª£c l√†m tr√≤n 2 ch·ªØ s·ªë (3.155 ‚Üí 3.16)
            // V√≠ d·ª•: Target 3.2 ‚Üí ch·ªâ c·∫ßn ƒë·∫°t 3.155 (‚Üí 3.16 ‚Üí 3.2)
            // Kho·∫£ng l√†m tr√≤n: [target - 0.05, target + 0.049...]
            // ƒê·ªÉ an to√†n, t√≠nh v·ªõi minTargetGPA = target - 0.044
            const minTargetGPA = targetGPA - 0.044;
            
            // Calculate required average score using MIN target (easier to achieve)
            // Formula: (currentWeightedSum + requiredAvg * pendingCredits) / (currentCredits + pendingCredits) = minTargetGPA
            // => requiredAvg = (minTargetGPA * (currentCredits + pendingCredits) - currentWeightedSum) / pendingCredits
            
            const totalFutureCredits = currentCredits + pendingCreditsSelected;
            const requiredWeightedSum = minTargetGPA * totalFutureCredits;
            const neededSum = requiredWeightedSum - currentWeightedSum;
            const requiredAvg4 = neededSum / pendingCreditsSelected;
            
            // Also calculate exact target (without rounding benefit) for comparison
            const exactRequiredAvg4 = (targetGPA * totalFutureCredits - currentWeightedSum) / pendingCreditsSelected;
            
            document.getElementById('requiredAvgDisplay').innerText = requiredAvg4.toFixed(2);
            
            // Generate analysis message
            let message = '';
            const selectedCoursesNames = selectedPending.map(c => `<span class="font-medium">${c.name}</span> (${c.credits} TC)`).join(', ');
            
            // Check if already achieved (considering rounding)
            const projectedGPA = currentCredits > 0 ? currentGPA : 0;
            const alreadyAchieved = projectedGPA >= minTargetGPA;
            
            if (requiredAvg4 > 4.0) {
                message = `
                    <div class="flex items-start gap-2 text-red-700 bg-red-50 p-3 rounded-lg">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                        <div>
                            <p class="font-semibold">Kh√¥ng th·ªÉ ƒë·∫°t ƒë∆∞·ª£c!</p>
                            <p class="text-sm mt-1">V·ªõi ${pendingCreditsSelected} t√≠n ch·ªâ ƒë√£ ch·ªçn, b·∫°n c·∫ßn ƒëi·ªÉm TB <b>${requiredAvg4.toFixed(2)}</b> (v∆∞·ª£t qu√° 4.0). H√£y ch·ªçn th√™m m√¥n ho·∫∑c h·∫° m·ª•c ti√™u GPA.</p>
                        </div>
                    </div>
                `;
            } else if (requiredAvg4 <= 0) {
                message = `
                    <div class="flex items-start gap-2 text-emerald-700 bg-emerald-50 p-3 rounded-lg">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <div>
                            <p class="font-semibold">ƒê√£ ƒë·∫°t m·ª•c ti√™u! üéâ</p>
                            <p class="text-sm mt-1">GPA hi·ªán t·∫°i c·ªßa b·∫°n (${currentGPA.toFixed(3)}) ƒë√£ ƒë·∫°t ho·∫∑c v∆∞·ª£t m·ª•c ti√™u ${targetGPA.toFixed(2)} (t√≠nh c·∫£ l√†m tr√≤n: ‚â•${minTargetGPA.toFixed(3)}).</p>
                        </div>
                    </div>
                `;
            } else {
                // Calculate score ranges needed
                const getScoreRange = (score4) => {
                    if (score4 >= 3.75) return { grade: 'A/A+', score10: '‚â• 8.5', color: 'text-emerald-600' };
                    if (score4 >= 3.25) return { grade: 'B+', score10: '8.0 - 8.4', color: 'text-blue-600' };
                    if (score4 >= 2.75) return { grade: 'B', score10: '7.0 - 7.9', color: 'text-cyan-600' };
                    if (score4 >= 2.25) return { grade: 'C+', score10: '6.5 - 6.9', color: 'text-yellow-600' };
                    if (score4 >= 1.75) return { grade: 'C', score10: '5.5 - 6.4', color: 'text-orange-600' };
                    if (score4 >= 1.25) return { grade: 'D+', score10: '5.0 - 5.4', color: 'text-red-500' };
                    if (score4 >= 0.75) return { grade: 'D', score10: '4.0 - 4.9', color: 'text-red-600' };
                    return { grade: 'F', score10: '< 4.0', color: 'text-red-700' };
                };
                
                const scoreRange = getScoreRange(requiredAvg4);
                
                // Calculate the "advantage" from rounding
                const roundingAdvantage = exactRequiredAvg4 - requiredAvg4;
                const roundingNote = roundingAdvantage > 0.001 
                    ? `<p class="text-xs text-slate-500 mt-2">üí° <span class="italic">L·ª£i th·∫ø l√†m tr√≤n: ƒêi·ªÉm TB g·ªëc c·∫ßn ${exactRequiredAvg4.toFixed(3)}, nh∆∞ng nh·ªù l√†m tr√≤n ch·ªâ c·∫ßn ${requiredAvg4.toFixed(3)} (gi·∫£m ${roundingAdvantage.toFixed(3)})</span></p>` 
                    : '';
                
                message = `
                    <div class="space-y-3">
                        <div class="flex items-start gap-2 text-blue-700 bg-blue-50 p-3 rounded-lg">
                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                            <div>
                                <p class="font-semibold">Ph√¢n t√≠ch: ${selectedPending.length} m√¥n (${pendingCreditsSelected} TC)</p>
                                <p class="text-sm mt-1">ƒê·ªÉ ƒë·∫°t GPA <b>${targetGPA.toFixed(2)}</b>, b·∫°n c·∫ßn ƒëi·ªÉm trung b√¨nh <b class="${scoreRange.color}">${requiredAvg4.toFixed(2)}</b> (H·ªá 4) ~ <b class="${scoreRange.color}">${scoreRange.grade}</b> (${scoreRange.score10} H·ªá 10).</p>
                                ${roundingNote}
                            </div>
                        </div>
                        <div class="text-xs text-slate-500">
                            <details class="cursor-pointer">
                                <summary class="font-medium hover:text-slate-700">üìã Xem danh s√°ch m√¥n ƒë√£ ch·ªçn</summary>
                                <p class="mt-2 pl-4 text-slate-600">${selectedCoursesNames}</p>
                            </details>
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = message;
        }

    </script>
    <script>
        // --- Header Scroll Effect Logic ---
        const header = document.getElementById('mainHeader');
        
        // H√†m x·ª≠ l√Ω s·ª± ki·ªán cu·ªôn
        const handleScroll = () => {
            if (window.scrollY > 10) {
                // TR·∫†NG TH√ÅI: ƒê√£ cu·ªôn xu·ªëng
                // 1. X√≥a hi·ªáu ·ª©ng k√≠nh m·ªù v√† vi·ªÅn x√°m nh·∫π
                header.classList.remove('glass-morphism', 'border-slate-200');
                
                // 2. Th√™m n·ªÅn tr·∫Øng ƒë·∫∑c v√† ƒë·ªï b√≥ng ƒë·∫≠m h∆°n
                header.classList.add('bg-white', 'shadow-md');
            } else {
                // TR·∫†NG TH√ÅI: ·ªû ƒë·∫ßu trang
                // 1. Tr·∫£ l·∫°i hi·ªáu ·ª©ng k√≠nh m·ªù v√† vi·ªÅn
                header.classList.add('glass-morphism', 'border-slate-200');
                
                // 2. X√≥a n·ªÅn tr·∫Øng ƒë·∫∑c v√† b√≥ng ƒë·∫≠m
                header.classList.remove('bg-white', 'shadow-md');
            }
        };

        // L·∫Øng nghe s·ª± ki·ªán scroll
        window.addEventListener('scroll', handleScroll);
    </script>
    </main>

    <div id="footer-placeholder"></div>
    <script src="load-components.js"></script>
</body>
</html>