<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch xu·∫•t L·ªãch thi t·ª´ MyBK</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* √Åp d·ª•ng font Inter l√†m font ch·ªØ m·∫∑c ƒë·ªãnh */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hi·ªáu ·ª©ng focus-visible t√πy ch·ªânh ƒë·ªÉ d·ªÖ nh√¨n h∆°n */
        .custom-focus:focus-visible {
            outline: 2px solid theme('colors.indigo.400');
            outline-offset: 2px;
        }
        /* Style cho b·∫£ng k·∫øt qu·∫£ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem; /* T∆∞∆°ng ƒë∆∞∆°ng mt-6 */
        }
        .result-table th, .result-table td {
            border: 1px solid #e5e7eb; /* T∆∞∆°ng ƒë∆∞∆°ng border-gray-200 */
            padding: 0.75rem 1rem; /* T∆∞∆°ng ƒë∆∞∆°ng p-3 px-4 */
            text-align: left;
            font-size: 0.875rem; /* T∆∞∆°ng ƒë∆∞∆°ng text-sm */
        }
        .result-table th {
            background-color: #f9fafb; /* T∆∞∆°ng ƒë∆∞∆°ng bg-gray-50 */
            font-weight: 600; /* T∆∞∆°ng ƒë∆∞∆°ng font-semibold */
            color: #374151; /* T∆∞∆°ng ƒë∆∞∆°ng text-gray-700 */
        }
        .result-table td {
            color: #1f2937; /* T∆∞∆°ng ƒë∆∞∆°ng text-gray-900 */
        }
        .result-table tr:nth-child(even) {
            background-color: #f9fafb; /* T∆∞∆°ng ƒë∆∞∆°ng even:bg-gray-50 */
        }
        /* Style cho danh s√°ch link Google Calendar */
        .gcal-link-list {
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }
        .gcal-link-item {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            color: #374151;
            font-weight: 500;
            text-decoration: none;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
            border: 1px solid #e5e7eb;
        }
        .gcal-link-item:hover {
            background-color: #f3f4f6;
        }
        
        /* Calendar Preview Styles */
        .calendar-preview {
            margin-top: 2rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #fff;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background-color: #eff6ff;
            border-bottom: 1px solid #dbeafe;
        }
        .calendar-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e40af;
        }
        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }
        .calendar-nav-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            background-color: #fff;
            border: 1px solid #bfdbfe;
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .calendar-nav-btn:hover {
            background-color: #dbeafe;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            border-bottom: 1px solid #e5e7eb;
        }
        .calendar-day-header {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: #64748b;
            background-color: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            text-transform: uppercase;
        }
        .calendar-day-header.today {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .calendar-time-header {
            background-color: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        .calendar-body {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
        }
        .calendar-time-slot {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            color: #94a3b8;
            text-align: right;
            border-right: 1px solid #e5e7eb;
            background-color: #fafafa;
            height: 40px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
        }
        .calendar-cell {
            border-right: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
            min-height: 40px;
            position: relative;
        }
        .calendar-cell:last-child {
            border-right: none;
        }
        .calendar-event {
            position: absolute;
            left: 2px;
            right: 2px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 3px solid #3b82f6;
            border-radius: 0.25rem;
            padding: 0.35rem 0.5rem;
            font-size: 0.7rem;
            color: #1e40af;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .calendar-event:hover {
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
            transform: translateX(1px);
        }
        .calendar-event-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .calendar-event-time {
            font-size: 0.65rem;
            color: #3b82f6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-event-room {
            font-size: 0.6rem;
            color: #64748b;
            margin-top: 2px;
        }
        .calendar-legend {
            display: flex;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            background-color: #f8fafc;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #64748b;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border-left: 3px solid;
        }
        .legend-gk {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .legend-ck {
            background-color: #dcfce7;
            border-color: #22c55e;
        }
        .calendar-event.event-ck {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left-color: #22c55e;
            color: #166534;
        }
        .calendar-event.event-ck:hover {
            background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
        }
        .calendar-event.event-ck .calendar-event-time {
            color: #22c55e;
        }
        .calendar-empty-message {
            grid-column: 1 / -1;
            padding: 3rem;
            text-align: center;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        .week-date {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e40af;
            display: block;
        }
        .week-date.today {
            background-color: #3b82f6;
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        /* Import Instructions Box */
        .import-instructions {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .import-instructions h4 {
            color: #0c4a6e;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .import-instructions ol {
            color: #075985;
            margin-left: 1.5rem;
            line-height: 1.8;
        }
        .import-instructions li {
            margin-bottom: 0.5rem;
        }
        .import-instructions code {
            background-color: #fff;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
            border: 1px solid #bae6fd;
        }
        .quick-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1.05rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(14, 165, 233, 0.3);
            width: 100%;
            justify-content: center;
        }
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(14, 165, 233, 0.4);
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        }
        .quick-action-btn:active {
            transform: translateY(0);
        }
        .quick-action-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        @media (max-width: 768px) {
            .quick-action-container {
                grid-template-columns: 1fr;
            }
        }
        /* Popup Blocker Instructions */
        .popup-instructions {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .popup-instructions h4 {
            color: #92400e;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .popup-instructions .browser-guide {
            background-color: #fff;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #fbbf24;
        }
        .popup-instructions .browser-guide h5 {
            color: #78350f;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .popup-instructions ol, .popup-instructions ul {
            color: #92400e;
            margin-left: 1.5rem;
            line-height: 1.8;
            font-size: 0.9rem;
        }
        .popup-instructions li {
            margin-bottom: 0.4rem;
        }
        .popup-instructions code {
            background-color: #fef3c7;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85em;
            border: 1px solid #fcd34d;
            font-weight: 500;
        }
        .popup-instructions .tip {
            background-color: #fef3c7;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #78350f;
            border-left: 3px solid #f59e0b;
        }

        /* Page chrome */
        .page-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page-main {
            flex: 1 0 auto;
            padding-top: 80px;
            padding-bottom: 40px;
        }
    </style>
</head>

<body class="bg-gray-100 antialiased">
    <div id="header-placeholder"></div>

    <div class="page-shell">
        <main class="page-main px-4">
            <!-- Ph·∫ßn t·ª≠ ch·ª©a to√†n b·ªô ·ª©ng d·ª•ng -->
            <div class="w-full max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        
        <!-- Ti√™u ƒë·ªÅ -->
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Tr√¨nh tr√≠ch xu·∫•t L·ªãch thi
        </h1>
        
        <!-- H∆∞·ªõng d·∫´n -->
        <p class="text-center text-gray-600 mb-4">
            D√°n to√†n b·ªô n·ªôi dung (Ctrl+A r·ªìi Ctrl+C) t·ª´ trang l·ªãch thi c·ªßa b·∫°n v√†o √¥ b√™n d∆∞·ªõi v√† nh·∫•n "Tr√≠ch xu·∫•t".
        </p>

        <!-- √î nh·∫≠p li·ªáu -->
        <textarea 
            id="rawTextInput"
            rows="10"
            class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none custom-focus shadow-sm"
            placeholder="D√°n n·ªôi dung web v√†o ƒë√¢y..."
        ></textarea>

        <!-- N√∫t x·ª≠ l√Ω -->
        <div class="text-center mt-4">
            <button 
                id="processButton"
                class="bg-indigo-600 text-white py-3 px-8 rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-200 custom-focus shadow-md"
            >
                Tr√≠ch xu·∫•t d·ªØ li·ªáu
            </button>
        </div>

        <!-- N√∫t h√†nh ƒë·ªông L·ªãch (·∫©n ban ƒë·∫ßu) -->
        <div id="calendarActions" class="hidden text-center mt-6 space-x-4">
            <button 
                id="saveGKButton"
                class="bg-green-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors duration-200 custom-focus shadow"
            >
                T·∫°o L·ªãch thi GK
            </button>
            <button 
                id="saveCKButton"
                class="bg-blue-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 custom-focus shadow"
            >
                T·∫°o L·ªãch thi CK
            </button>
            <button 
                id="saveAllButton"
                class="bg-purple-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-colors duration-200 custom-focus shadow"
            >
                üöÄ T·∫°o T·∫§T C·∫¢ L·ªãch (GK + CK)
            </button>
        </div>

        <!-- V√πng Popup Blocker Instructions -->
        <div id="popupInstructionsContainer" class="hidden">
            <div class="popup-instructions">
                <h4>‚ö†Ô∏è C√°ch t·∫Øt ch·∫∑n popup cho n√∫t "üöÄ T·∫°o T·∫§T C·∫¢ L·ªãch"</h4>
                <p style="color: #92400e; margin-bottom: 1rem; font-size: 0.9rem;">
                    ƒê·ªÉ n√∫t "T·∫°o T·∫§T C·∫¢ L·ªãch" c√≥ th·ªÉ m·ªü nhi·ªÅu tab Google Calendar c√πng l√∫c, b·∫°n c·∫ßn cho ph√©p popup t·ª´ trang n√†y.
                </p>
                
                <div class="browser-guide">
                    <h5>üåê Chrome / Edge / Brave</h5>
                    <ol>
                        <li>Nh√¨n v√†o <strong>thanh ƒë·ªãa ch·ªâ</strong> (URL bar) ·ªü ƒë·∫ßu tr√¨nh duy·ªát</li>
                        <li>T√¨m bi·ªÉu t∆∞·ª£ng <code>üö´</code> ho·∫∑c <code>üîí</code> b√™n tr√°i URL</li>
                        <li>Click v√†o bi·ªÉu t∆∞·ª£ng ƒë√≥</li>
                        <li>Ch·ªçn <strong>"Cho ph√©p popup"</strong> ho·∫∑c <strong>"Allow pop-ups"</strong></li>
                        <li>T·∫£i l·∫°i trang v√† th·ª≠ l·∫°i</li>
                    </ol>
                </div>

                <div class="browser-guide">
                    <h5>ü¶ä Firefox</h5>
                    <ol>
                        <li>Nh√¨n v√†o <strong>thanh ƒë·ªãa ch·ªâ</strong> (URL bar)</li>
                        <li>T√¨m bi·ªÉu t∆∞·ª£ng <code>üö´</code> ho·∫∑c th√¥ng b√°o popup b·ªã ch·∫∑n</li>
                        <li>Click v√†o bi·ªÉu t∆∞·ª£ng ƒë√≥ ‚Üí ch·ªçn <strong>"Options"</strong></li>
                        <li>Ch·ªçn <strong>"Allow pop-ups for [t√™n trang]"</strong></li>
                        <li>T·∫£i l·∫°i trang v√† th·ª≠ l·∫°i</li>
                    </ol>
                </div>

                <div class="browser-guide">
                    <h5>üçé Safari (Mac)</h5>
                    <ol>
                        <li>Menu <strong>Safari</strong> ‚Üí <strong>Settings</strong></li>
                        <li>Tab <strong>"Websites"</strong> ‚Üí ch·ªçn <strong>"Pop-up Windows"</strong></li>
                        <li>T√¨m trang web n√†y trong danh s√°ch</li>
                        <li>Ch·ªçn <strong>"Allow"</strong></li>
                        <li>ƒê√≥ng Settings v√† t·∫£i l·∫°i trang</li>
                    </ol>
                </div>

                <div class="tip">
                    <strong>üí° M·∫πo:</strong> N·∫øu v·∫´n kh√¥ng ƒë∆∞·ª£c, h√£y s·ª≠ d·ª•ng c√°c n√∫t <strong>"T·∫£i .ics & M·ªü Google Calendar"</strong> ·ªü ph√≠a d∆∞·ªõi.
                    C√°ch n√†y ch·ªâ m·ªü 1 tab v√† kh√¥ng b·ªã ch·∫∑n popup!
                </div>
            </div>
        </div>

        <!-- V√πng hi·ªÉn th·ªã k·∫øt qu·∫£ b·∫£ng -->
        <div id="tableResultContainer" class="mt-8">
            <!-- Th√¥ng b√°o l·ªói/tr·ªëng s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y -->
        </div>

        <!-- V√πng hi·ªÉn th·ªã link Google Calendar -->
        <div id="calendarLinksContainer" class="mt-6">
            <!-- C√°c link Google Calendar s·∫Ω ƒë∆∞·ª£c t·∫°o ·ªü ƒë√¢y -->
        </div>

        <!-- V√πng Import Instructions -->
        <div id="importInstructionsContainer" class="hidden">
            <div class="import-instructions">
                <h4>üì• C√°ch th√™m T·∫§T C·∫¢ l·ªãch thi v√†o Google Calendar (Khuy·∫øn ngh·ªã)</h4>
                <ol>
                    <li>Click n√∫t <strong>"T·∫£i file .ics v√† M·ªü Google Calendar"</strong> b√™n d∆∞·ªõi</li>
                    <li>File <code>.ics</code> s·∫Ω ƒë∆∞·ª£c t·∫£i xu·ªëng v√† Google Calendar s·∫Ω t·ª± ƒë·ªông m·ªü</li>
                    <li>Trong Google Calendar, nh·∫•p v√†o bi·ªÉu t∆∞·ª£ng <strong>‚öôÔ∏è (Settings)</strong> ·ªü g√≥c tr√™n b√™n ph·∫£i</li>
                    <li>Ch·ªçn <strong>"Import & Export"</strong> t·ª´ menu b√™n tr√°i</li>
                    <li>Click <strong>"Select file from your computer"</strong> v√† ch·ªçn file <code>.ics</code> v·ª´a t·∫£i</li>
                    <li>Ch·ªçn l·ªãch b·∫°n mu·ªën th√™m v√†o (m·∫∑c ƒë·ªãnh l√† l·ªãch ch√≠nh)</li>
                    <li>Nh·∫•n <strong>"Import"</strong> ‚Üí Ho√†n t·∫•t! ‚úÖ</li>
                </ol>
                <div class="quick-action-container">
                    <button class="quick-action-btn" id="downloadAndOpenGK">
                        üìÖ T·∫£i .ics GK & M·ªü Google Calendar
                    </button>
                    <button class="quick-action-btn" id="downloadAndOpenCK">
                        üìÖ T·∫£i .ics CK & M·ªü Google Calendar
                    </button>
                </div>
            </div>
        </div>

        <!-- V√πng hi·ªÉn th·ªã Calendar Preview -->
        <div id="calendarPreviewContainer" class="hidden">
            <div class="calendar-preview">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendarWeekTitle">L·ªãch thi tu·∫ßn</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prevWeekBtn">‚Üê Tu·∫ßn tr∆∞·ªõc</button>
                        <button class="calendar-nav-btn" id="todayBtn">H√¥m nay</button>
                        <button class="calendar-nav-btn" id="nextWeekBtn">Tu·∫ßn sau ‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarDayHeaders">
                    <!-- Day headers will be generated here -->
                </div>
                <div class="calendar-body" id="calendarBody">
                    <!-- Calendar content will be generated here -->
                </div>
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-gk"></div>
                        <span>Gi·ªØa k·ª≥ (GK/Ktr)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-ck"></div>
                        <span>Cu·ªëi k·ª≥ (CK/Thi)</span>
                    </div>
                </div>
            </div>
        </div>

            </div>
        </main>

        <div id="footer-placeholder"></div>
    </div>

    <script src="load-components.js"></script>
    <script>
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const rawTextInput = document.getElementById('rawTextInput');
        const processButton = document.getElementById('processButton');
        const tableResultContainer = document.getElementById('tableResultContainer'); // ƒê·ªïi t√™n
        
        // Th√™m c√°c ph·∫ßn t·ª≠ m·ªõi
        const calendarActions = document.getElementById('calendarActions');
        const saveGKButton = document.getElementById('saveGKButton');
        const saveCKButton = document.getElementById('saveCKButton');
        const saveAllButton = document.getElementById('saveAllButton');
        const calendarLinksContainer = document.getElementById('calendarLinksContainer');
        
        // Ph·∫ßn t·ª≠ cho Popup Instructions
        const popupInstructionsContainer = document.getElementById('popupInstructionsContainer');
        
        // Ph·∫ßn t·ª≠ cho Import Instructions
        const importInstructionsContainer = document.getElementById('importInstructionsContainer');
        const downloadAndOpenGK = document.getElementById('downloadAndOpenGK');
        const downloadAndOpenCK = document.getElementById('downloadAndOpenCK');

        // Ph·∫ßn t·ª≠ cho Calendar Preview
        const calendarPreviewContainer = document.getElementById('calendarPreviewContainer');
        const calendarDayHeaders = document.getElementById('calendarDayHeaders');
        const calendarBody = document.getElementById('calendarBody');
        const calendarWeekTitle = document.getElementById('calendarWeekTitle');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const todayBtn = document.getElementById('todayBtn');

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ƒë√£ tr√≠ch xu·∫•t
        let currentExtractedData = [];
        
        // BI·∫æN M·ªöI: L∆∞u tr·ªØ c√°c s·ª± ki·ªán ƒë√£ ƒë∆∞·ª£c l·ªçc cho t·ªáp .ics
        let currentFilteredEvents = [];

        // Bi·∫øn cho Calendar Preview
        let currentWeekStart = getMonday(new Date());
        let calendarEvents = [];

        // G·∫Øn s·ª± ki·ªán cho navigation buttons
        prevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        nextWeekBtn.addEventListener('click', () => navigateWeek(1));
        todayBtn.addEventListener('click', () => {
            currentWeekStart = getMonday(new Date());
            renderCalendarPreview();
        });
        
        // ƒê·ªãnh nghƒ©a ti√™u ƒë·ªÅ b·∫£ng
        const TABLE_HEADERS = [
            "H·ªçc k·ª≥", "M√¥n h·ªçc", "Nh√≥m l·ªõp", "Ng√†y thi", "Lo·∫°i thi", "C∆° s·ªü", 
            "M√£ ph√≤ng", "Th·ª©", "Gi·ªù b·∫Øt ƒë·∫ßu", "T·ªïng s·ªë ph√∫t", "C·∫≠p nh·∫≠t"
        ];

        // G·∫Øn s·ª± ki·ªán click cho n√∫t
        processButton.addEventListener('click', processRawText);
        // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t l·ªãch
        saveGKButton.addEventListener('click', () => generateCalendarLinks('GK'));
        saveCKButton.addEventListener('click', () => generateCalendarLinks('CK'));
        saveAllButton.addEventListener('click', () => openAllCalendarLinks());
        
        // G·∫Øn s·ª± ki·ªán cho quick action buttons
        downloadAndOpenGK.addEventListener('click', () => downloadAndOpenCalendar('GK'));
        downloadAndOpenCK.addEventListener('click', () => downloadAndOpenCalendar('CK'));


        function processRawText() {
            const rawText = rawTextInput.value;
            // ·∫®n c√°c n√∫t h√†nh ƒë·ªông v√† x√≥a link c≈© khi x·ª≠ l√Ω
            calendarActions.classList.add('hidden');
            calendarLinksContainer.innerHTML = "";
            calendarPreviewContainer.classList.add('hidden');
            importInstructionsContainer.classList.add('hidden');
            popupInstructionsContainer.classList.add('hidden');
            currentExtractedData = [];
            currentFilteredEvents = []; // X√≥a c√°c s·ª± ki·ªán ƒë√£ l·ªçc
            calendarEvents = [];

            if (rawText.trim() === "") {
                displayMessage("Vui l√≤ng d√°n n·ªôi dung v√†o √¥ vƒÉn b·∫£n.", "error");
                return;
            }

            // 1. X√°c ƒë·ªãnh kh·ªëi d·ªØ li·ªáu
            // T√¨m ch√≠nh x√°c chu·ªói header b·∫±ng k√Ω t·ª± tab (\t)
            const headerString = "H·ªçc k·ª≥\tM√¥n h·ªçc\tNh√≥m l·ªõp\tNg√†y thi\tLo·∫°i thi\tC∆° s·ªü\tM√£ ph√≤ng\tTh·ª©\tGi·ªù b·∫Øt ƒë·∫ßu\tT·ªïng s·ªë ph√∫t\tC·∫≠p nh·∫≠t cu·ªëi c√πng v√†o l√∫c";
            const footerString = "Tr√¨nh b√†y t·ª´ d√≤ng";
            
            const dataStartIndex_header = rawText.indexOf(headerString);

            if (dataStartIndex_header === -1) {
                displayMessage("Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu quan tr·ªçng (kh√¥ng th·∫•y header). Vui l√≤ng ƒë·∫£m b·∫£o b·∫°n ƒë√£ sao ch√©p to√†n b·ªô trang. H√£y th·ª≠ sao ch√©p l·∫°i.", "error");
                return;
            }

            // V·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa d·ªØ li·ªáu l√† ngay sau chu·ªói header
            const dataStartIndex = dataStartIndex_header + headerString.length;
            
            // C·∫Øt l·∫•y ph·∫ßn vƒÉn b·∫£n sau header
            let dataBlock = rawText.substring(dataStartIndex);
            
            // C·∫Øt b·ªè ph·∫ßn footer
            const dataEndIndex = dataBlock.indexOf(footerString);
            if (dataEndIndex !== -1) {
                dataBlock = dataBlock.substring(0, dataEndIndex);
            }
            dataBlock = dataBlock.trim();

            // 2. T√°ch c√°c d√≤ng
            const rowStrings = dataBlock.split('\n').filter(r => r.trim() !== "");

            if (rowStrings.length === 0) {
                displayMessage("ƒê√£ t√¨m th·∫•y b·∫£ng nh∆∞ng kh√¥ng c√≥ d·ªØ li·ªáu n√†o.", "info");
                return;
            }

            // 3. T√°ch b·∫±ng tab
            const extractedData = [];
            let failedRows = 0;

            // 4. Ph√¢n t√≠ch t·ª´ng d√≤ng
            for (const rowString of rowStrings) {
                const cells = rowString.trim().split('\t'); // T√°ch c√°c √¥ b·∫±ng k√Ω t·ª± tab
                
                // Ki·ªÉm tra xem c√≥ ƒë√∫ng 11 c·ªôt kh√¥ng (b·∫±ng s·ªë l∆∞·ª£ng ti√™u ƒë·ªÅ)
                if (cells.length === TABLE_HEADERS.length) {
                    extractedData.push(cells.map(cell => cell.trim())); // Th√™m v√† l√†m s·∫°ch
                } else if (cells.length > 1) { // B·ªè qua c√°c d√≤ng tr·ªëng c√≥ th·ªÉ b·ªã s√≥t l·∫°i
                    failedRows++;
                    console.warn(`Kh√¥ng th·ªÉ ph√¢n t√≠ch d√≤ng (sai s·ªë c·ªôt, mong ƒë·ª£i ${TABLE_HEADERS.length}, nh·∫≠n ƒë∆∞·ª£c ${cells.length}):`, rowString);
                }
            }

            // 5. Hi·ªÉn th·ªã k·∫øt qu·∫£
            if (extractedData.length > 0) {
                displayResults(extractedData, failedRows);
                // T·∫°o calendar events v√† hi·ªÉn th·ªã preview
                generateCalendarEvents(extractedData);
                renderCalendarPreview();
                calendarPreviewContainer.classList.remove('hidden');
                // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n import v√† popup
                importInstructionsContainer.classList.remove('hidden');
                popupInstructionsContainer.classList.remove('hidden');
            } else {
                displayMessage("Kh√¥ng th·ªÉ tr√≠ch xu·∫•t d·ªØ li·ªáu t·ª´ n·ªôi dung ƒë√£ d√°n. C·∫•u tr√∫c c√≥ th·ªÉ ƒë√£ thay ƒë·ªïi.", "error");
            }
        }

        function displayMessage(message, type = "info") {
            let colorClass = "bg-blue-100 border-blue-400 text-blue-700";
            if (type === "error") {
                colorClass = "bg-red-100 border-red-400 text-red-700";
            } else if (type === "warning") {
                colorClass = "bg-yellow-100 border-yellow-400 text-yellow-700";
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o trong container b·∫£ng
            tableResultContainer.innerHTML = `<div class="border-l-4 ${colorClass} p-4 rounded" role="alert">
                <p class="font-bold">${type === 'error' ? 'L·ªói' : 'Th√¥ng b√°o'}</p>
                <p>${message}</p>
            </div>`;
        }

        function displayResults(data, failedRows) {
            tableResultContainer.innerHTML = ""; // X√≥a n·ªôi dung c≈©

            // L∆∞u tr·ªØ d·ªØ li·ªáu ƒë·ªÉ t·∫°o l·ªãch
            currentExtractedData = data;
            // Hi·ªÉn th·ªã c√°c n√∫t t·∫°o l·ªãch
            calendarActions.classList.remove('hidden');
            // X√≥a c√°c link l·ªãch c≈©
            calendarLinksContainer.innerHTML = "";

            if (failedRows > 0) {
                // T·∫°m th·ªùi hi·ªÉn th·ªã th√¥ng b√°o l·ªói ngay tr√™n ƒë·∫ßu
                const warnMsg = document.createElement('div');
                warnMsg.innerHTML = `<div class="border-l-4 bg-yellow-100 border-yellow-400 text-yellow-700 p-4 rounded mb-4" role="alert">
                    <p class="font-bold">C·∫£nh b√°o</p>
                    <p>Tr√≠ch xu·∫•t th√†nh c√¥ng ${data.length} d√≤ng. ${failedRows} d√≤ng th·∫•t b·∫°i (xem console ƒë·ªÉ bi·∫øt chi ti·∫øt).</p>
                </div>`;
                tableResultContainer.appendChild(warnMsg);
            }

            const table = document.createElement('table');
            table.className = "result-table rounded-lg overflow-hidden shadow";
            
            // T·∫°o Thead
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            TABLE_HEADERS.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            // T·∫°o Tbody
            const tbody = table.createTBody();
            data.forEach(rowData => {
                const tr = tbody.insertRow();
                rowData.forEach(cellData => {
                    const td = tr.insertCell();
                    td.textContent = cellData.trim(); // L√†m s·∫°ch d·ªØ li·ªáu cell
                });
            });

            tableResultContainer.appendChild(table);
        }

        /**
         * H√†m helper ƒë·ªÉ t√¨m ch·ªâ m·ª•c (index) c·ªßa c√°c c·ªôt c·∫ßn thi·∫øt.
         * Tr·∫£ v·ªÅ m·ªôt object map t√™n c·ªôt v√† ch·ªâ m·ª•c.
         */
        function findColumnIndices() {
            const indices = {
                hocKy: TABLE_HEADERS.indexOf("H·ªçc k·ª≥"),
                monHoc: TABLE_HEADERS.indexOf("M√¥n h·ªçc"),
                ngayThi: TABLE_HEADERS.indexOf("Ng√†y thi"),
                loaiThi: TABLE_HEADERS.indexOf("Lo·∫°i thi"),
                maPhong: TABLE_HEADERS.indexOf("M√£ ph√≤ng"),
                gioBatDau: TABLE_HEADERS.indexOf("Gi·ªù b·∫Øt ƒë·∫ßu"),
                tongPhut: TABLE_HEADERS.indexOf("T·ªïng s·ªë ph√∫t")
            };
            
            // Ki·ªÉm tra n·∫øu b·∫•t k·ª≥ c·ªôt n√†o kh√¥ng t√¨m th·∫•y (-1)
            for (const key in indices) {
                if (indices[key] === -1) {
                    console.error(`Kh√¥ng t√¨m th·∫•y c·ªôt: ${key}`);
                    displayMessage(`L·ªói c·∫•u h√¨nh: Kh√¥ng t√¨m th·∫•y c·ªôt "${key}" trong TABLE_HEADERS.`, "error");
                    return null;
                }
            }
            return indices;
        }

        /**
         * Ph√¢n t√≠ch ng√†y, gi·ªù v√† l√†m tr√≤n th·ªùi gian k·∫øt th√∫c
         */
        function parseAndRoundDateTime(dateStr, timeStr, durationMinutes) {
            try {
                // dateStr = "2025-10-20"
                // timeStr = "07g00" ho·∫∑c "13g00"
                const [year, month, day] = dateStr.split('-').map(Number);
                const [hour, minute] = timeStr.replace('g', '').match(/.{1,2}/g).map(Number);
                
                // Th√°ng trong JavaScript l√† 0-indexed (0-11)
                const startTime = new Date(year, month - 1, day, hour, minute);

                // T√≠nh th·ªùi gian k·∫øt th√∫c
                const endTime = new Date(startTime.getTime() + durationMinutes * 60000);

                // --- Logic l√†m tr√≤n l√™n 30 ph√∫t ---
                const endMinutes = endTime.getMinutes();
                
                if (endMinutes > 0 && endMinutes <= 30) {
                    // N·∫øu l√† 1-30, l√†m tr√≤n l√™n 30
                    endTime.setMinutes(30);
                    endTime.setSeconds(0);
                    endTime.setMilliseconds(0);
                } else if (endMinutes > 30) {
                    // N·∫øu l√† 31-59, l√†m tr√≤n l√™n gi·ªù ti·∫øp theo
                    endTime.setHours(endTime.getHours() + 1);
                    endTime.setMinutes(0);
                    endTime.setSeconds(0);
                    endTime.setMilliseconds(0);
                }
                // N·∫øu l√† 0 ho·∫∑c 30, gi·ªØ nguy√™n

                return { startTime, endTime };
            } catch (e) {
                console.error("L·ªói ph√¢n t√≠ch ng√†y gi·ªù:", dateStr, timeStr, e);
                return null;
            }
        }

        /**
         * ƒê·ªãnh d·∫°ng Date object th√†nh chu·ªói YYYYMMDDTHHmmSS cho Google Calendar
         */
        function formatDateForGCalLink(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}00`;
        }

        /**
         * H√†m ch√≠nh ƒë·ªÉ t·∫°o v√† hi·ªÉn th·ªã c√°c link Google Calendar
         */
        function generateCalendarLinks(mode) { // mode l√† 'GK' ho·∫∑c 'CK'
            calendarLinksContainer.innerHTML = ""; // X√≥a link c≈©
            
            // S·ª¨A L·ªñI: Ch·ªâ khai b√°o 'indices' M·ªòT L·∫¶N
            const indices = findColumnIndices();
            if (!indices) return; // L·ªói ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã

            // X√≥a c√°c s·ª± ki·ªán ƒë√£ l·ªçc tr∆∞·ªõc ƒë√≥
            currentFilteredEvents = [];

            // L·ªçc d·ªØ li·ªáu d·ª±a tr√™n mode (GK/CK)
            const filteredData = currentExtractedData.filter(row => {
                const loaiThi = row[indices.loaiThi];
                // Ch·∫•p nh·∫≠n 'GK' ho·∫∑c 'Ktr' (cho Gi·ªØa k·ª≥)
                if (mode === 'GK') return loaiThi === 'GK' || loaiThi === 'Ktr';
                // Ch·∫•p nh·∫≠n 'CK' ho·∫∑c 'Thi' (cho Cu·ªëi k·ª≥)
                if (mode === 'CK') return loaiThi === 'CK' || loaiThi === 'Thi';
                return false;
            });

            if (filteredData.length === 0) {
                calendarLinksContainer.innerHTML = `<p class="text-gray-600">Kh√¥ng t√¨m th·∫•y l·ªãch thi n√†o cho lo·∫°i <strong>${mode}</strong>.</p>`;
                return;
            }

            const links = [];

            for (const row of filteredData) {
                const hocKy = row[indices.hocKy];
                const monHoc = row[indices.monHoc];
                const maPhong = row[indices.maPhong];
                const ngayThi = row[indices.ngayThi];
                const gioBatDau = row[indices.gioBatDau];
                const tongPhut = parseInt(row[indices.tongPhut], 10);

                const dateTimes = parseAndRoundDateTime(ngayThi, gioBatDau, tongPhut);
                if (!dateTimes) continue; // B·ªè qua n·∫øu l·ªói ph√¢n t√≠ch

                const { startTime, endTime } = dateTimes;

                // 1. T·∫°o Ti√™u ƒë·ªÅ
                const title = `[${mode}] ${monHoc}`;

                // 2. T·∫°o m√¥ t·∫£
                const description = `M√¥n h·ªçc: ${monHoc}\nM√£ ph√≤ng: ${maPhong}\nH·ªçc k·ª≥: ${hocKy}`;

                // 3. T·∫°o chu·ªói th·ªùi gian
                const dates = `${formatDateForGCalLink(startTime)}/${formatDateForGCalLink(endTime)}`;

                // 4. T·∫°o link
                const gcalLink = new URL('https://www.google.com/calendar/render');
                gcalLink.searchParams.set('action', 'TEMPLATE');
                gcalLink.searchParams.set('text', title);
                gcalLink.searchParams.set('dates', dates);
                gcalLink.searchParams.set('details', description);
                gcalLink.searchParams.set('location', `Ph√≤ng: ${maPhong}`); // Th√™m v·ªã tr√≠

                links.push({
                    href: gcalLink.href,
                    text: `${monHoc} (${ngayThi} l√∫c ${gioBatDau})`
                });

                // L∆ØU D·ªÆ LI·ªÜU CHO N√öT "TH√äM T·∫§T C·∫¢"
                currentFilteredEvents.push({
                    startTime,
                    endTime,
                    title,
                    description,
                    location: `Ph√≤ng: ${maPhong}`,
                    hocKy: hocKy // TH√äM H·ªåC K·ª≤ V√ÄO ƒê√ÇY
                });
            }

            // Hi·ªÉn th·ªã c√°c link
            const listTitle = document.createElement('h3');
            listTitle.className = "text-xl font-semibold text-gray-700";
            listTitle.textContent = `C√°c link Google Calendar cho ${mode} (${links.length}):`;
            calendarLinksContainer.appendChild(listTitle);

            const list = document.createElement('div');
            list.className = "gcal-link-list";
            links.forEach(link => {
                const a = document.createElement('a');
                a.href = link.href;
                a.textContent = link.text;
                a.className = "gcal-link-item";
                a.target = "_blank"; // M·ªü trong tab m·ªõi
                a.rel = "noopener noreferrer";
                list.appendChild(a);
            });
            calendarLinksContainer.appendChild(list);

            // TH√äM N√öT "T·∫¢I T·ªÜP .ICS (TH√äM T·∫§T C·∫¢)"
            if (links.length > 0) {
                const addAllButton = document.createElement('button');
                addAllButton.id = 'addAllToCalendarButton';
                addAllButton.textContent = `T·∫£i t·ªáp .ics (Th√™m t·∫•t c·∫£ ${mode})`;
                // C·∫≠p nh·∫≠t class ƒë·ªÉ c√≥ kho·∫£ng c√°ch
                addAllButton.className = "mt-6 w-full bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-800 transition-colors duration-200 custom-focus shadow";
                
                addAllButton.onclick = () => downloadICSFile(mode);
                
                // Ch√®n n√∫t "Th√™m t·∫•t c·∫£" v√†o TR∆Ø·ªöC ti√™u ƒë·ªÅ danh s√°ch
                calendarLinksContainer.insertBefore(addAllButton, listTitle);
            }
        }

        /**
         * H√ÄM M·ªöI: L·∫•y th·ªùi gian UTC cho DTSTAMP
         */
        function getUTCDateString(date) {
            return date.toISOString().replace(/[-:.]/g, '').substring(0, 15) + 'Z';
        }

        /**
         * H√ÄM M·ªöI: T·∫°o v√† t·∫£i t·ªáp .ics
         */
        function downloadICSFile(mode) {
            if (currentFilteredEvents.length === 0) {
                displayMessage("Kh√¥ng c√≥ s·ª± ki·ªán n√†o ƒë·ªÉ t·∫°o t·ªáp .ics.", "error");
                return;
            }

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//TrinhTrichXuatLichThi//VN',
            ];

            const dtStamp = getUTCDateString(new Date());

            currentFilteredEvents.forEach((event, index) => {
                const uid = `lichthi-${Date.now()}-${index}@bachkhoa.edu.vn`;
                const dtStart = formatDateForGCalLink(event.startTime);
                const dtEnd = formatDateForGCalLink(event.endTime);
                const summary = event.title;
                const description = event.description.replace(/\n/g, '\\n'); // Escape newlines cho .ics
                const location = event.location;

                icsContent.push('BEGIN:VEVENT');
                icsContent.push(`UID:${uid}`);
                icsContent.push(`DTSTAMP:${dtStamp}`);
                icsContent.push(`DTSTART:${dtStart}`);
                icsContent.push(`DTEND:${dtEnd}`);
                icsContent.push(`SUMMARY:${summary}`);
                icsContent.push(`DESCRIPTION:${description}`);
                icsContent.push(`LOCATION:${location}`);
                icsContent.push('END:VEVENT');
            });

            icsContent.push('END:VCALENDAR');

            const icsString = icsContent.join('\n');
            const blob = new Blob([icsString], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // L·∫•y h·ªçc k·ª≥ t·ª´ s·ª± ki·ªán ƒë·∫ßu ti√™n (gi·∫£ s·ª≠ t·∫•t c·∫£ ƒë·ªÅu c√πng h·ªçc k·ª≥)
            const hocKy = currentFilteredEvents[0].hocKy; // v√≠ d·ª•: "20251"
            // L·∫•y 3 k√Ω t·ª± cu·ªëi c·ªßa h·ªçc k·ª≥
            const kyHocCode = hocKy.slice(-3); // v√≠ d·ª•: "251"

            const a = document.createElement('a');
            a.href = url;
            // C·∫≠p nh·∫≠t t√™n t·ªáp theo y√™u c·∫ßu
            a.download = `LichThi_${mode}_${kyHocCode}.ics`; // T√™n t·ªáp, v√≠ d·ª•: LichThi_CK_251.ics
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * H√ÄM: T·∫°o t·∫•t c·∫£ link Google Calendar v√† m·ªü popup
         */
        function openAllCalendarLinks() {
            const indices = findColumnIndices();
            if (!indices) return;

            const allLinks = [];

            for (const row of currentExtractedData) {
                const hocKy = row[indices.hocKy];
                const monHoc = row[indices.monHoc];
                const maPhong = row[indices.maPhong];
                const ngayThi = row[indices.ngayThi];
                const gioBatDau = row[indices.gioBatDau];
                const tongPhut = parseInt(row[indices.tongPhut], 10);
                const loaiThi = row[indices.loaiThi];

                const dateTimes = parseAndRoundDateTime(ngayThi, gioBatDau, tongPhut);
                if (!dateTimes) continue;

                const { startTime, endTime } = dateTimes;

                // X√°c ƒë·ªãnh lo·∫°i thi
                let mode = 'GK';
                if (loaiThi === 'CK' || loaiThi === 'Thi') {
                    mode = 'CK';
                }

                // T·∫°o Ti√™u ƒë·ªÅ
                const title = `[${mode}] ${monHoc}`;

                // T·∫°o m√¥ t·∫£
                const description = `M√¥n h·ªçc: ${monHoc}\nM√£ ph√≤ng: ${maPhong}\nH·ªçc k·ª≥: ${hocKy}`;

                // T·∫°o chu·ªói th·ªùi gian
                const dates = `${formatDateForGCalLink(startTime)}/${formatDateForGCalLink(endTime)}`;

                // T·∫°o link
                const gcalLink = new URL('https://www.google.com/calendar/render');
                gcalLink.searchParams.set('action', 'TEMPLATE');
                gcalLink.searchParams.set('text', title);
                gcalLink.searchParams.set('dates', dates);
                gcalLink.searchParams.set('details', description);
                gcalLink.searchParams.set('location', `Ph√≤ng: ${maPhong}`);

                allLinks.push(gcalLink.href);
            }

            if (allLinks.length === 0) {
                displayMessage("Kh√¥ng c√≥ l·ªãch thi n√†o ƒë·ªÉ t·∫°o.", "error");
                return;
            }

            // Hi·ªÉn th·ªã c·∫£nh b√°o v·ªÅ popup blocker
            const confirmMsg = `S·∫Ω m·ªü ${allLinks.length} tab Google Calendar.\n\n‚ö†Ô∏è L∆∞u √Ω:\n- Tr√¨nh duy·ªát c√≥ th·ªÉ ch·∫∑n popup. H√£y cho ph√©p popup t·ª´ trang n√†y.\n- C√°c tab s·∫Ω ƒë∆∞·ª£c m·ªü v·ªõi kho·∫£ng c√°ch 500ms ƒë·ªÉ tr√°nh b·ªã ch·∫∑n.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }

            // M·ªü c√°c tab v·ªõi delay ƒë·ªÉ tr√°nh b·ªã ch·∫∑n
            let openedCount = 0;
            let blockedCount = 0;

            allLinks.forEach((link, index) => {
                setTimeout(() => {
                    const newWindow = window.open(link, '_blank');
                    if (newWindow) {
                        openedCount++;
                    } else {
                        blockedCount++;
                    }

                    // Th√¥ng b√°o khi ho√†n th√†nh
                    if (index === allLinks.length - 1) {
                        setTimeout(() => {
                            if (blockedCount > 0) {
                                alert(`‚úÖ ƒê√£ m·ªü ${openedCount} tab.\n‚ùå ${blockedCount} tab b·ªã ch·∫∑n.\n\nH√£y cho ph√©p popup v√† th·ª≠ l·∫°i, ho·∫∑c s·ª≠ d·ª•ng n√∫t "T·∫£i t·ªáp .ics" ƒë·ªÉ th√™m t·∫•t c·∫£ c√πng l√∫c.`);
                            } else {
                                alert(`‚úÖ ƒê√£ m·ªü t·∫•t c·∫£ ${openedCount} tab Google Calendar th√†nh c√¥ng!`);
                            }
                        }, 3000);
                    }
                }, index * 3000); // Delay 3000ms gi·ªØa m·ªói tab
            });
        }

        /**
         * H√ÄM M·ªöI: T·∫£i file .ics v√† m·ªü Google Calendar Import page
         */
        function downloadAndOpenCalendar(mode) {
            // T·∫°o v√† l·ªçc events
            const indices = findColumnIndices();
            if (!indices) return;

            currentFilteredEvents = [];

            const filteredData = currentExtractedData.filter(row => {
                const loaiThi = row[indices.loaiThi];
                if (mode === 'GK') return loaiThi === 'GK' || loaiThi === 'Ktr';
                if (mode === 'CK') return loaiThi === 'CK' || loaiThi === 'Thi';
                return false;
            });

            if (filteredData.length === 0) {
                alert(`Kh√¥ng t√¨m th·∫•y l·ªãch thi n√†o cho lo·∫°i ${mode}.`);
                return;
            }

            for (const row of filteredData) {
                const hocKy = row[indices.hocKy];
                const monHoc = row[indices.monHoc];
                const maPhong = row[indices.maPhong];
                const ngayThi = row[indices.ngayThi];
                const gioBatDau = row[indices.gioBatDau];
                const tongPhut = parseInt(row[indices.tongPhut], 10);

                const dateTimes = parseAndRoundDateTime(ngayThi, gioBatDau, tongPhut);
                if (!dateTimes) continue;

                const { startTime, endTime } = dateTimes;

                const title = `[${mode}] ${monHoc}`;
                const description = `M√¥n h·ªçc: ${monHoc}\nM√£ ph√≤ng: ${maPhong}\nH·ªçc k·ª≥: ${hocKy}`;

                currentFilteredEvents.push({
                    startTime,
                    endTime,
                    title,
                    description,
                    location: `Ph√≤ng: ${maPhong}`,
                    hocKy: hocKy
                });
            }

            // T·∫°o file .ics
            const icsContent = generateICSContent();
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const hocKy = currentFilteredEvents[0].hocKy;
            const kyHocCode = hocKy.slice(-3);

            const a = document.createElement('a');
            a.href = url;
            a.download = `LichThi_${mode}_${kyHocCode}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // M·ªü Google Calendar Settings/Import page
            setTimeout(() => {
                const gcalImportUrl = 'https://calendar.google.com/calendar/u/0/r/settings/export';
                const newWindow = window.open(gcalImportUrl, '_blank');
                
                if (!newWindow) {
                    alert(`‚úÖ File ${a.download} ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng!\n\n‚ö†Ô∏è Kh√¥ng th·ªÉ t·ª± ƒë·ªông m·ªü Google Calendar (popup b·ªã ch·∫∑n).\n\nVui l√≤ng:\n1. V√†o Google Calendar\n2. Nh·∫•p ‚öôÔ∏è Settings ‚Üí Import & Export\n3. Import file v·ª´a t·∫£i`);
                } else {
                    alert(`‚úÖ File ${a.download} ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng!\n\nüìå Google Calendar ƒë√£ m·ªü. L√†m theo c√°c b∆∞·ªõc:\n1. Nh·∫•p ‚öôÔ∏è (Settings) ·ªü g√≥c tr√™n b√™n ph·∫£i\n2. Ch·ªçn "Import & Export" t·ª´ menu b√™n tr√°i\n3. Nh·∫•p "Select file" v√† ch·ªçn file v·ª´a t·∫£i\n4. Nh·∫•n "Import" ‚Üí Xong!`);
                }
            }, 500);
        }

        /**
         * H√ÄM: T·∫°o n·ªôi dung ICS t·ª´ currentFilteredEvents
         */
        function generateICSContent() {
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//TrinhTrichXuatLichThi//VN',
            ];

            const dtStamp = getUTCDateString(new Date());

            currentFilteredEvents.forEach((event, index) => {
                const uid = `lichthi-${Date.now()}-${index}@bachkhoa.edu.vn`;
                const dtStart = formatDateForGCalLink(event.startTime);
                const dtEnd = formatDateForGCalLink(event.endTime);
                const summary = event.title;
                const description = event.description.replace(/\n/g, '\\n');
                const location = event.location;

                icsContent.push('BEGIN:VEVENT');
                icsContent.push(`UID:${uid}`);
                icsContent.push(`DTSTAMP:${dtStamp}`);
                icsContent.push(`DTSTART:${dtStart}`);
                icsContent.push(`DTEND:${dtEnd}`);
                icsContent.push(`SUMMARY:${summary}`);
                icsContent.push(`DESCRIPTION:${description}`);
                icsContent.push(`LOCATION:${location}`);
                icsContent.push('END:VEVENT');
            });

            icsContent.push('END:VCALENDAR');
            return icsContent.join('\n');
        }

        /**
         * H√ÄM: L·∫•y ng√†y th·ª© Hai c·ªßa tu·∫ßn ch·ª©a ng√†y ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh
         */
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        /**
         * H√ÄM: Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu tr√≠ch xu·∫•t th√†nh calendar events
         */
        function generateCalendarEvents(data) {
            calendarEvents = [];
            const indices = findColumnIndices();
            if (!indices) return;

            for (const row of data) {
                const monHoc = row[indices.monHoc];
                const maPhong = row[indices.maPhong];
                const ngayThi = row[indices.ngayThi];
                const gioBatDau = row[indices.gioBatDau];
                const tongPhut = parseInt(row[indices.tongPhut], 10);
                const loaiThi = row[indices.loaiThi];

                const dateTimes = parseAndRoundDateTime(ngayThi, gioBatDau, tongPhut);
                if (!dateTimes) continue;

                const { startTime, endTime } = dateTimes;

                // X√°c ƒë·ªãnh lo·∫°i thi
                let examType = 'GK';
                if (loaiThi === 'CK' || loaiThi === 'Thi') {
                    examType = 'CK';
                }

                calendarEvents.push({
                    title: monHoc,
                    room: maPhong,
                    startTime: startTime,
                    endTime: endTime,
                    type: examType,
                    originalTime: gioBatDau,
                    duration: tongPhut
                });
            }

            // T√¨m tu·∫ßn c√≥ l·ªãch thi ƒë·∫ßu ti√™n v√† nh·∫£y ƒë·∫øn ƒë√≥
            if (calendarEvents.length > 0) {
                const sortedEvents = [...calendarEvents].sort((a, b) => a.startTime - b.startTime);
                currentWeekStart = getMonday(sortedEvents[0].startTime);
            }
        }

        /**
         * H√ÄM: Di chuy·ªÉn tu·∫ßn
         */
        function navigateWeek(direction) {
            const newDate = new Date(currentWeekStart);
            newDate.setDate(newDate.getDate() + (direction * 7));
            currentWeekStart = newDate;
            renderCalendarPreview();
        }

        /**
         * H√ÄM: Render Calendar Preview
         */
        function renderCalendarPreview() {
            const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            const fullDays = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ tu·∫ßn
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const formatDate = (d) => `${d.getDate()}/${d.getMonth() + 1}`;
            calendarWeekTitle.textContent = `Tu·∫ßn ${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}/${weekEnd.getFullYear()}`;

            // Render headers
            calendarDayHeaders.innerHTML = '<div class="calendar-time-header calendar-day-header"></div>';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(dayDate.getDate() + i);
                const isToday = dayDate.getTime() === today.getTime();
                
                const dayHeader = document.createElement('div');
                dayHeader.className = `calendar-day-header ${isToday ? 'today' : ''}`;
                dayHeader.innerHTML = `
                    <div>${days[(i + 1) % 7]}</div>
                    <span class="week-date ${isToday ? 'today' : ''}">${dayDate.getDate()}</span>
                `;
                calendarDayHeaders.appendChild(dayHeader);
            }

            // L·ªçc events trong tu·∫ßn hi·ªán t·∫°i
            const weekEndDate = new Date(currentWeekStart);
            weekEndDate.setDate(weekEndDate.getDate() + 7);
            
            const weekEvents = calendarEvents.filter(event => {
                return event.startTime >= currentWeekStart && event.startTime < weekEndDate;
            });

            // T√¨m kho·∫£ng gi·ªù c·∫ßn hi·ªÉn th·ªã
            let minHour = 7;
            let maxHour = 18;
            
            if (weekEvents.length > 0) {
                weekEvents.forEach(event => {
                    const startHour = event.startTime.getHours();
                    const endHour = event.endTime.getHours() + (event.endTime.getMinutes() > 0 ? 1 : 0);
                    minHour = Math.min(minHour, startHour);
                    maxHour = Math.max(maxHour, endHour);
                });
            }

            // Render body
            calendarBody.innerHTML = '';
            
            if (weekEvents.length === 0) {
                calendarBody.innerHTML = '<div class="calendar-empty-message">Kh√¥ng c√≥ l·ªãch thi trong tu·∫ßn n√†y</div>';
                return;
            }

            // T·∫°o grid cho c√°c time slots
            for (let hour = minHour; hour <= maxHour; hour++) {
                // Time label
                const timeSlot = document.createElement('div');
                timeSlot.className = 'calendar-time-slot';
                timeSlot.textContent = `${hour}:00`;
                calendarBody.appendChild(timeSlot);

                // Cells cho m·ªói ng√†y
                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell';
                    cell.dataset.day = day;
                    cell.dataset.hour = hour;
                    calendarBody.appendChild(cell);
                }
            }

            // ƒê·∫∑t events v√†o calendar
            weekEvents.forEach(event => {
                const eventDate = new Date(event.startTime);
                const dayIndex = (eventDate.getDay() + 6) % 7; // Chuy·ªÉn ƒë·ªïi: CN=6, T2=0, T3=1, ...
                
                const startHour = event.startTime.getHours();
                const startMinute = event.startTime.getMinutes();
                const endHour = event.endTime.getHours();
                const endMinute = event.endTime.getMinutes();

                // T√≠nh v·ªã tr√≠ v√† chi·ªÅu cao
                const topOffset = (startHour - minHour) * 40 + (startMinute / 60) * 40;
                const duration = (endHour - startHour) * 60 + (endMinute - startMinute);
                const height = (duration / 60) * 40 - 2;

                // T√¨m cell ƒë·ªÉ ƒë·∫∑t event
                const cell = calendarBody.querySelector(`[data-day="${dayIndex}"][data-hour="${startHour}"]`);
                if (!cell) {
                    // N·∫øu kh√¥ng t√¨m th·∫•y cell ch√≠nh x√°c, t√¨m cell g·∫ßn nh·∫•t
                    const fallbackCell = calendarBody.querySelector(`[data-day="${dayIndex}"][data-hour="${minHour}"]`);
                    if (fallbackCell) {
                        placeEvent(fallbackCell, event, topOffset, height);
                    }
                } else {
                    placeEvent(cell, event, (startMinute / 60) * 40, height);
                }
            });
        }

        /**
         * H√ÄM: ƒê·∫∑t event v√†o cell
         */
        function placeEvent(cell, event, topOffset, height) {
            const eventEl = document.createElement('div');
            eventEl.className = `calendar-event ${event.type === 'CK' ? 'event-ck' : ''}`;
            eventEl.style.top = `${topOffset}px`;
            eventEl.style.height = `${Math.max(height, 30)}px`;
            
            const timeStr = `${event.originalTime.replace('g', ':')} - ${formatTimeDisplay(event.endTime)}`;
            
            eventEl.innerHTML = `
                <div class="calendar-event-title">${event.title}</div>
                <div class="calendar-event-time">${timeStr}</div>
                ${height > 45 ? `<div class="calendar-event-room">üìç ${event.room}</div>` : ''}
            `;
            
            eventEl.title = `${event.title}\n${timeStr}\nPh√≤ng: ${event.room}`;
            
            cell.appendChild(eventEl);
        }

        /**
         * H√ÄM: Format th·ªùi gian hi·ªÉn th·ªã
         */
        function formatTimeDisplay(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

    </script>
</body>
</html>     