<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DKMH Previewer - Xem tr∆∞·ªõc l·ªãch h·ªçc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
        }

        .page-main {
            flex: 1 0 auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .input-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .input-section h2 {
            color: #5a67d8;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .input-section p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            height: 200px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            margin-left: 10px;
        }

        /* Schedule Table Styles */
        .schedule-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        /* Page chrome */
        .page-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page-main {
            flex: 1 0 auto;
            padding-top: 80px;
        }

        .site-footer {
            flex-shrink: 0;
        }

        .schedule-section h2 {
            color: #5a67d8;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 4px;
            min-width: 900px;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .schedule-table td {
            background: #f7fafc;
            padding: 8px;
            text-align: center;
            border-radius: 10px;
            height: 60px;
            vertical-align: middle;
            position: relative;
        }

        .time-cell {
            background: #edf2f7;
            font-weight: 500;
            color: #4a5568;
            font-size: 12px;
            min-width: 80px;
        }

        /* Course Cell Styles */
        .course-cell {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .course-cell:hover {
            transform: scale(1.5);
            z-index: 100;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }

        /* Faded style for "Sinh ho·∫°t sinh vi√™n" courses */
        .course-cell.faded .course-content {
            opacity: 0.5;
        }

        .course-cell.faded:hover .course-content {
            opacity: 0.8;
        }

        .course-content {
            border-radius: 10px;
            padding: 8px 5px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .course-code {
            font-weight: 600;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .course-name {
            font-size: 10px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
        }

        .course-room {
            font-size: 9px;
            margin-top: 2px;
            opacity: 0.8;
        }

        /* Hover expanded info */
        .course-cell:hover .course-content {
            padding: 10px;
        }

        .course-cell:hover .course-code {
            font-size: 13px;
        }

        .course-cell:hover .course-name {
            font-size: 12px;
        }

        .course-cell:hover .course-room {
            font-size: 11px;
        }

        .course-cell:hover .course-extra {
            display: block;
        }

        .course-extra {
            display: none;
            font-size: 10px;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(255,255,255,0.3);
            text-align: left;
            width: 100%;
        }

        .course-extra div {
            margin: 2px 0;
        }

        /* Color palette for courses */
        .color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
        .color-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
        .color-7 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; }
        .color-8 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; }
        .color-9 { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); color: #333; }
        .color-10 { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); color: #333; }

        /* Summary section */
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-label {
            color: #718096;
            font-size: 14px;
        }

        .summary-value {
            color: #5a67d8;
            font-weight: 600;
            font-size: 18px;
        }

        /* Course list */
        .course-list {
            margin-top: 20px;
        }

        .course-list h3 {
            color: #5a67d8;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .course-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: transform 0.2s ease;
        }

        .course-item:hover {
            transform: translateX(5px);
        }

        .course-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .course-item-info {
            flex: 1;
        }

        .course-item-code {
            font-weight: 600;
            color: #4a5568;
        }

        .course-item-name {
            font-size: 14px;
            color: #718096;
        }

        .course-item-details {
            font-size: 12px;
            color: #a0aec0;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #a0aec0;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Instructions */
        .instructions {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            border-radius: 0 10px 10px 0;
            margin-bottom: 15px;
        }

        .instructions h4 {
            color: #2b6cb0;
            margin-bottom: 8px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #4a5568;
            font-size: 14px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .instructions code {
            background: #bee3f8;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Main layout with sidebar */
        .main-layout {
            display: flex;
            gap: 20px;
        }

        .main-content {
            flex: 1;
        }

        /* Preview sidebar */
        .preview-sidebar {
            width: 350px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .preview-sidebar h3 {
            color: #5a67d8;
            margin-bottom: 15px;
            font-weight: 500;
            font-size: 16px;
        }

        .preview-sidebar textarea {
            height: 150px;
            font-size: 12px;
        }

        .preview-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-preview {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-preview.cs1 {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .btn-preview.cs1:hover {
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }

        .btn-clear-preview {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Preview course cell styles */
        .course-cell.preview {
            cursor: default;
        }

        .course-cell.preview:hover {
            transform: none;
            box-shadow: none;
        }

        .course-cell.preview .course-content {
            background: rgba(156, 163, 175, 0.4) !important;
            color: #374151;
        }

        .course-cell.preview .course-code {
            font-size: 10px;
        }

        .course-cell.preview .course-name {
            font-size: 9px;
        }

        .course-cell.preview .course-extra {
            display: none !important;
        }

        /* Conflict cell styles */
        .course-cell.conflict-cell {
            padding: 0;
        }

        .conflict-container {
            display: flex;
            width: 100%;
            height: 100%;
            gap: 2px;
        }

        .conflict-half {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 5px;
            border-radius: 8px;
            min-width: 0;
        }

        .conflict-half .course-code {
            font-size: 9px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conflict-half .course-name {
            font-size: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conflict-half.preview-conflict {
            background: rgba(239, 68, 68, 0.7) !important;
            color: white;
            position: relative;
        }

        .conflict-half.preview-conflict::before {
            content: '‚ö†Ô∏è';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }

        /* Conflict log styles */
        .conflict-log {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .conflict-log h4 {
            color: #dc2626;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .conflict-log ul {
            margin: 0;
            padding-left: 20px;
        }

        .conflict-log li {
            color: #991b1b;
            font-size: 13px;
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
            }

            .preview-sidebar {
                width: 100%;
                position: static;
            }
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="page-shell">
        <main class="page-main">
    
    <div class="container">
        <h1>üìÖ DKMH Previewer - Xem tr∆∞·ªõc L·ªãch H·ªçc</h1>
        
        <div class="input-section">
            <h2>üìã B∆∞·ªõc 1: D√°n th√¥ng tin l·ªãch ƒë√£ ƒëƒÉng k√Ω</h2>
            <div class="instructions">
                <h4>H∆∞·ªõng d·∫´n:</h4>
                <ol>
                    <li>M·ªü trang ƒëƒÉng k√Ω m√¥n h·ªçc (mybk.hcmut.edu.vn)</li>
                    <li>Nh·∫•n <code>Ctrl + A</code> ƒë·ªÉ ch·ªçn t·∫•t c·∫£ n·ªôi dung</li>
                    <li>Nh·∫•n <code>Ctrl + C</code> ƒë·ªÉ sao ch√©p</li>
                    <li>D√°n v√†o √¥ b√™n d∆∞·ªõi (<code>Ctrl + V</code>)</li>
                    <li>Nh·∫•n n√∫t "Xem l·ªãch h·ªçc"</li>
                </ol>
            </div>
            <textarea id="inputData" placeholder="D√°n n·ªôi dung Ctrl+A t·ª´ trang ƒëƒÉng k√Ω m√¥n h·ªçc v√†o ƒë√¢y..."></textarea>
            <br>
            <button class="btn" onclick="parseAndDisplay()">üìä Xem l·ªãch h·ªçc</button>
            <button class="btn btn-clear" onclick="clearAll()">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
        </div>

        <div class="main-layout">
            <div class="main-content">
                <div class="schedule-section" id="scheduleSection">
                    <h2>üìÜ L·ªãch h·ªçc c·ªßa b·∫°n</h2>
                    <div id="scheduleContent">
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p>Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch h·ªçc. Vui l√≤ng d√°n th√¥ng tin t·ª´ trang ƒêKMH.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="preview-sidebar">
                <h3>üîç B∆∞·ªõc 2: Preview m√¥n m·ªõi</h3>
                <div class="instructions" style="margin-bottom: 10px; padding: 10px;">
                    <small>D√°n th√¥ng tin t·ª´ trang ch·ªçn m√¥n h·ªçc ƒëƒÉng k√Ω (Ctrl+A sau khi search m√¥n)</small>
                </div>
                <textarea id="previewData" placeholder="D√°n n·ªôi dung Ctrl+A t·ª´ trang ch·ªçn m√¥n h·ªçc..."></textarea>
                <div class="preview-buttons">
                    <button class="btn-preview" onclick="previewCourses('cs2')">
                        üè´ Preview C∆° s·ªü 2 (L##, D2--)
                    </button>
                    <button class="btn-preview cs1" onclick="previewCourses('cs1')">
                        üè´ Preview C∆° s·ªü 1 (CC##, CH##, ...)
                    </button>
                </div>
                <button class="btn-clear-preview" onclick="clearPreview()">üóëÔ∏è X√≥a preview</button>
            </div>
        </div>
    </div>

    <script>
        // Time period mapping
        const periodTimes = {
            1: { start: '06:00', end: '06:50' },
            2: { start: '07:00', end: '07:50' },
            3: { start: '08:00', end: '08:50' },
            4: { start: '09:00', end: '09:50' },
            5: { start: '10:00', end: '10:50' },
            6: { start: '11:00', end: '11:50' },
            7: { start: '12:00', end: '12:50' },
            8: { start: '13:00', end: '13:50' },
            9: { start: '14:00', end: '14:50' },
            10: { start: '15:00', end: '15:50' },
            11: { start: '16:00', end: '16:50' },
            12: { start: '17:00', end: '17:50' },
            13: { start: '18:00', end: '18:50' },
            14: { start: '18:50', end: '19:40' },
            15: { start: '19:40', end: '20:30' },
            16: { start: '20:30', end: '21:20' },
            17: { start: '21:20', end: '22:10' }
        };

        // Day mapping
        const dayMapping = {
            'Th·ª© 2': 0,
            'Th·ª© 3': 1,
            'Th·ª© 4': 2,
            'Th·ª© 5': 3,
            'Th·ª© 6': 4,
            'Th·ª© 7': 5,
            'Ch·ªß Nh·∫≠t': 6,
            'CN': 6
        };

        // Function to normalize day string
        function normalizeDay(day) {
            if (!day) return null;
            // Remove extra spaces and normalize
            const normalized = day.replace(/\s+/g, ' ').trim();
            // Try direct match first
            if (dayMapping[normalized] !== undefined) {
                return normalized;
            }
            // Try matching "Th·ª© X" pattern
            const match = normalized.match(/Th·ª©\s*(\d)/i);
            if (match) {
                return 'Th·ª© ' + match[1];
            }
            return normalized;
        }

        function getDayIndex(day) {
            const normalized = normalizeDay(day);
            return dayMapping[normalized];
        }

        const dayNames = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'CN'];

        let courses = [];

        function parseInput(text) {
            courses = [];
            
            const lines = text.split('\n');
            let currentCourseBase = null; // Base course info (code, name, credits)
            let currentGroup = ''; // Current group (e.g., "L01" or "L01_L02")
            let currentInstructor = '';
            let waitingForSchedule = false;
            
            console.log('Total lines:', lines.length);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Skip empty lines
                if (!trimmedLine) continue;
                
                // Match course header: "1ME4625 - K·ªπ nƒÉng l√£nh ƒë·∫°o3.0"
                const courseMatch = trimmedLine.match(/^(\d+)([A-Z]{2}\d{4})\s*-\s*(.+?)(\d+\.?\d*)$/);
                
                if (courseMatch) {
                    console.log('Found course:', courseMatch[2], courseMatch[3]);
                    currentCourseBase = {
                        index: parseInt(courseMatch[1]),
                        code: courseMatch[2],
                        name: courseMatch[3].trim(),
                        credits: parseFloat(courseMatch[4])
                    };
                    currentGroup = '';
                    currentInstructor = '';
                    waitingForSchedule = false;
                    continue;
                }
                
                // Match group line (L01, CH01, or combined L01_L02, CC01_CC02)
                if (currentCourseBase && /^(L\d+|CH\d+|CC\d+)(_[A-Z0-9]+)?[\t\s]/.test(trimmedLine)) {
                    const groupMatch = trimmedLine.match(/^(L\d+|CH\d+|CC\d+)(_[A-Z0-9]+)?/);
                    if (groupMatch) {
                        currentGroup = groupMatch[0]; // Full group like "L01_L02"
                        console.log('Found group:', currentGroup);
                    }
                    
                    // Check for instructor in same line
                    const instructorMatch = trimmedLine.match(/"([^"]+)"/);
                    if (instructorMatch) {
                        currentInstructor = instructorMatch[1];
                    } else {
                        currentInstructor = '';
                    }
                    
                    waitingForSchedule = true;
                    continue;
                }
                
                // Skip header line "Th·ª©	Ti·∫øt	Ph√≤ng..."
                if (trimmedLine.includes('Ti·∫øt') && trimmedLine.includes('Ph√≤ng') && trimmedLine.includes('Tu·∫ßn h·ªçc')) {
                    console.log('Skipping header line');
                    continue;
                }
                
                // Check if this is a schedule line
                const firstPart = trimmedLine.split('\t')[0].trim();
                const hasRoom = /[HBAC]\d+-\d+|DHQG/.test(trimmedLine);
                
                // Match schedule line - check if starts with day name
                const isDayLine = (
                    firstPart.charCodeAt(0) === 84 || // 'T' for Th·ª©
                    firstPart === 'CN' ||
                    firstPart.startsWith('Ch∆∞a')
                );
                
                if (currentCourseBase && currentGroup && (isDayLine || hasRoom) && !trimmedLine.includes('Tu·∫ßn h·ªçc')) {
                    console.log('>>> Schedule line detected:', trimmedLine.substring(0, 80));
                    
                    // Extract day
                    let day = '';
                    
                    // Check for "Ch∆∞a bi·∫øt"
                    if (firstPart.startsWith('Ch∆∞a') || firstPart.includes('Ch∆∞a')) {
                        day = 'Ch∆∞a bi·∫øt';
                    }
                    // Check for "Th·ª© X"
                    else if (firstPart.charCodeAt(0) === 84 || firstPart.includes('Th')) {
                        const digitMatch = firstPart.match(/[2-7]/);
                        if (digitMatch) {
                            day = 'Th·ª© ' + digitMatch[0];
                        }
                    }
                    // Check for CN
                    else if (firstPart === 'CN' || firstPart.startsWith('CN')) {
                        day = 'CN';
                    }
                    
                    console.log('Extracted day:', day);
                    
                    // Skip if "Ch∆∞a bi·∫øt"
                    if (day === 'Ch∆∞a bi·∫øt' || !day) {
                        continue;
                    }
                    
                    // Extract periods and room from the line
                    const parts = trimmedLine.split('\t');
                    let periods = [];
                    let room = '';
                    let campus = '';
                    
                    if (parts.length >= 2) {
                        const periodStr = parts[1] || '';
                        const periodParts = periodStr.trim().split(/\s+/);
                        
                        periodParts.forEach((p) => {
                            const periodNum = parseInt(p);
                            if (!isNaN(periodNum) && periodNum > 0 && periodNum <= 17) {
                                periods.push(periodNum);
                            }
                        });
                        
                        if (parts[2]) {
                            room = parts[2].trim();
                        }
                        if (parts[3]) {
                            campus = parts[3].trim();
                        }
                    }
                    
                    // Create a new course entry for this schedule line
                    if (day && periods.length > 0) {
                        const courseEntry = {
                            index: currentCourseBase.index,
                            code: currentCourseBase.code,
                            name: currentCourseBase.name,
                            credits: currentCourseBase.credits,
                            group: currentGroup,
                            instructor: currentInstructor,
                            day: day,
                            periods: periods,
                            room: room,
                            campus: campus
                        };
                        courses.push(courseEntry);
                        console.log('‚úÖ Added course entry:', courseEntry.code, courseEntry.group, courseEntry.day, courseEntry.periods);
                    }
                }
            }
            
            console.log('Parsed courses:', courses);
            
            return courses;
        }

        function getTimeRange(periods) {
            if (periods.length === 0) return '';
            
            const sortedPeriods = [...periods].sort((a, b) => a - b);
            const startPeriod = sortedPeriods[0];
            const endPeriod = sortedPeriods[sortedPeriods.length - 1];
            
            const startTime = periodTimes[startPeriod]?.start || '';
            const endTime = periodTimes[endPeriod]?.end || '';
            
            return `${startTime} - ${endTime}`;
        }

        function generateScheduleTable() {
            if (courses.length === 0) {
                return `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p>Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc n√†o c√≥ l·ªãch c·ª• th·ªÉ. Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu ƒë·∫ßu v√†o.</p>
                    </div>
                `;
            }

            // Create schedule grid
            // Find min and max periods
            let minPeriod = 16, maxPeriod = 1;
            courses.forEach(c => {
                c.periods.forEach(p => {
                    if (p < minPeriod) minPeriod = p;
                    if (p > maxPeriod) maxPeriod = p;
                });
            });
            
            // Also check preview courses for min/max
            previewCoursesList.forEach(c => {
                c.periods.forEach(p => {
                    if (p < minPeriod) minPeriod = p;
                    if (p > maxPeriod) maxPeriod = p;
                });
            });

            // Build the table
            let html = `<table class="schedule-table">
                <thead>
                    <tr>
                        <th>Ti·∫øt/Gi·ªù</th>
                        ${dayNames.map(d => `<th>${d}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>`;

            // Create a grid to track which cells are occupied
            const grid = {};
            const cellSpans = {};
            const conflicts = []; // Track conflicts for logging

            // Add main courses to grid
            courses.forEach((course, courseIdx) => {
                const dayIdx = getDayIndex(course.day);
                if (dayIdx === undefined) {
                    console.log('Invalid day:', course.day, 'for course:', course.code);
                    return;
                }

                const sortedPeriods = [...course.periods].sort((a, b) => a - b);
                const startPeriod = sortedPeriods[0];
                const rowspan = sortedPeriods.length;

                // Mark the starting cell
                const key = `${startPeriod}-${dayIdx}`;
                grid[key] = {
                    course: course,
                    colorIdx: (courseIdx % 10) + 1,
                    rowspan: rowspan,
                    isPreview: false,
                    conflicts: [] // Array to hold conflicting courses
                };

                // Mark other cells as occupied (to skip them)
                for (let i = 1; i < sortedPeriods.length; i++) {
                    const skipKey = `${sortedPeriods[i]}-${dayIdx}`;
                    cellSpans[skipKey] = { parentKey: key };
                }
            });

            // Add preview courses to grid (handle conflicts)
            previewCoursesList.forEach((course) => {
                const dayIdx = getDayIndex(course.day);
                if (dayIdx === undefined) {
                    console.log('Invalid day for preview:', course.day, 'for course:', course.code);
                    return;
                }

                const sortedPeriods = [...course.periods].sort((a, b) => a - b);
                const startPeriod = sortedPeriods[0];
                const rowspan = sortedPeriods.length;

                // Check if any cell in this range is already occupied
                let conflictingCourse = null;
                let conflictKey = null;
                let conflictIsPreview = false;
                for (let p of sortedPeriods) {
                    const checkKey = `${p}-${dayIdx}`;
                    if (grid[checkKey]) {
                        conflictingCourse = grid[checkKey].course;
                        conflictKey = checkKey;
                        conflictIsPreview = grid[checkKey].isPreview;
                        break;
                    }
                    if (cellSpans[checkKey]) {
                        // Find the parent cell
                        const parentKey = cellSpans[checkKey].parentKey;
                        if (grid[parentKey]) {
                            conflictingCourse = grid[parentKey].course;
                            conflictKey = parentKey;
                            conflictIsPreview = grid[parentKey].isPreview;
                            break;
                        }
                    }
                }

                if (conflictingCourse) {
                    // There's a conflict!
                    const conflictType = conflictIsPreview ? 'preview-preview' : 'preview-registered';
                    
                    // Add isPreview property to conflictWith for display
                    const conflictInfo = {
                        previewCourse: course,
                        conflictWith: { ...conflictingCourse, isPreview: conflictIsPreview },
                        type: conflictType
                    };
                    conflicts.push(conflictInfo);
                    
                    // Add this preview course to the existing cell's conflicts
                    if (grid[conflictKey]) {
                        grid[conflictKey].conflicts.push({
                            course: course,
                            isPreview: true
                        });
                    }
                    
                    console.log(`‚ö†Ô∏è Conflict: Preview "${course.code} - ${course.group}" conflicts with "${conflictingCourse.code}"`);
                } else {
                    // No conflict, place normally
                    const key = `${startPeriod}-${dayIdx}`;
                    grid[key] = {
                        course: course,
                        colorIdx: 0, // Preview uses special color
                        rowspan: rowspan,
                        isPreview: true,
                        conflicts: []
                    };

                    // Mark other cells as occupied (to skip them)
                    for (let i = 1; i < sortedPeriods.length; i++) {
                        const skipKey = `${sortedPeriods[i]}-${dayIdx}`;
                        cellSpans[skipKey] = { parentKey: key };
                    }
                }
            });
            
            // Store conflicts globally for display
            window.currentConflicts = conflicts;

            // Generate rows
            for (let period = minPeriod; period <= maxPeriod; period++) {
                const time = periodTimes[period];
                html += `<tr>
                    <td class="time-cell">
                        <strong>Ti·∫øt ${period}</strong><br>
                        <small>${time.start} - ${time.end}</small>
                    </td>`;

                for (let day = 0; day < 7; day++) {
                    const key = `${period}-${day}`;
                    
                    // Skip if this cell is part of a rowspan
                    if (cellSpans[key]) {
                        continue;
                    }

                    if (grid[key]) {
                        const cell = grid[key];
                        const course = cell.course;
                        const timeRange = getTimeRange(course.periods);
                        
                        // Check if there are conflicts
                        if (cell.conflicts && cell.conflicts.length > 0) {
                            // Render conflict cell - split display
                            html += `
                                <td class="course-cell conflict-cell" rowspan="${cell.rowspan}">
                                    <div class="conflict-container">`;
                            
                            // First half - the original course
                            if (cell.isPreview) {
                                html += `
                                        <div class="conflict-half" style="background: rgba(156, 163, 175, 0.4);">
                                            <div class="course-code">${course.code}</div>
                                            <div class="course-name">${course.group}</div>
                                        </div>`;
                            } else {
                                const isFaded = course.name.includes('Sinh ho·∫°t sinh vi√™n') ? 'faded' : '';
                                html += `
                                        <div class="conflict-half color-${cell.colorIdx} ${isFaded}">
                                            <div class="course-code">${course.code}</div>
                                            <div class="course-name">${course.name}</div>
                                        </div>`;
                            }
                            
                            // Second half - conflicting course(s) with warning style
                            cell.conflicts.forEach(conflict => {
                                const conflictCourse = conflict.course;
                                html += `
                                        <div class="conflict-half preview-conflict">
                                            <div class="course-code">${conflictCourse.code}</div>
                                            <div class="course-name">${conflictCourse.group}</div>
                                        </div>`;
                            });
                            
                            html += `
                                    </div>
                                </td>`;
                        } else if (cell.isPreview) {
                            // Preview course - simplified display
                            html += `
                                <td class="course-cell preview" rowspan="${cell.rowspan}">
                                    <div class="course-content">
                                        <div class="course-code">${course.code}</div>
                                        <div class="course-name">${course.group}</div>
                                    </div>
                                </td>`;
                        } else {
                            // Regular course
                            const isFaded = course.name.includes('Sinh ho·∫°t sinh vi√™n') ? 'faded' : '';
                            html += `
                                <td class="course-cell ${isFaded}" rowspan="${cell.rowspan}">
                                    <div class="course-content color-${cell.colorIdx}">
                                        <div class="course-code">${course.code}</div>
                                        <div class="course-name">${course.name}</div>
                                        <div class="course-room">üìç ${course.room}</div>
                                        <div class="course-extra">
                                            <div>‚è∞ ${timeRange}</div>
                                            <div>üìö ${course.credits} t√≠n ch·ªâ</div>
                                            <div>üë• Nh√≥m: ${course.group}</div>
                                            ${course.instructor ? `<div>üë®‚Äçüè´ ${course.instructor}</div>` : ''}
                                        </div>
                                    </div>
                                </td>`;
                        }
                    } else {
                        html += `<td></td>`;
                    }
                }

                html += `</tr>`;
            }

            html += `</tbody></table>`;

            // Summary
            const totalCredits = courses.reduce((sum, c) => sum + c.credits, 0);
            html += `
                <div class="summary">
                    <div class="summary-item">
                        <span class="summary-label">T·ªïng s·ªë m√¥n:</span>
                        <span class="summary-value">${courses.length}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">T·ªïng t√≠n ch·ªâ:</span>
                        <span class="summary-value">${totalCredits}</span>
                    </div>
                </div>
            `;

            // Course list
            html += `
                <div class="course-list">
                    <h3>üìö Danh s√°ch m√¥n h·ªçc</h3>
                    ${courses.map((course, idx) => `
                        <div class="course-item">
                            <div class="course-color-dot color-${(idx % 10) + 1}"></div>
                            <div class="course-item-info">
                                <div class="course-item-code">${course.code} - ${course.name}</div>
                                <div class="course-item-details">
                                    ${course.day} | Ti·∫øt ${course.periods.join(', ')} | ${getTimeRange(course.periods)} | Ph√≤ng ${course.room} | ${course.credits} TC | Nh√≥m ${course.group}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Conflict log - show if there are any conflicts
            if (conflicts.length > 0) {
                html += `
                    <div class="conflict-log">
                        <h4>‚ö†Ô∏è C·∫£nh b√°o tr√πng l·ªãch (${conflicts.length})</h4>
                        <ul>
                            ${conflicts.map(c => {
                                const previewInfo = `${c.previewCourse.code} - ${c.previewCourse.group}`;
                                const conflictInfo = c.conflictWith.isPreview 
                                    ? `${c.conflictWith.code} - ${c.conflictWith.group}` 
                                    : `${c.conflictWith.code} - ${c.conflictWith.name}`;
                                return `<li>M√¥n preview <strong>"${previewInfo}"</strong> ƒëang b·ªã tr√πng v·ªõi m√¥n <strong>"${conflictInfo}"</strong></li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
            }

            return html;
        }

        function parseAndDisplay() {
            const input = document.getElementById('inputData').value;
            
            if (!input.trim()) {
                alert('Vui l√≤ng d√°n th√¥ng tin t·ª´ trang ƒëƒÉng k√Ω m√¥n h·ªçc!');
                return;
            }

            parseInput(input);
            const scheduleHtml = generateScheduleTable();
            document.getElementById('scheduleContent').innerHTML = scheduleHtml;
        }

        function clearAll() {
            document.getElementById('inputData').value = '';
            courses = [];
            document.getElementById('scheduleContent').innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch h·ªçc. Vui l√≤ng d√°n th√¥ng tin t·ª´ trang ƒêKMH.</p>
                </div>
            `;
        }

        // ============ TASK 2: Preview new courses ============
        let previewCoursesList = [];

        function parsePreviewInput(text, campusFilter) {
            const previewCourses = [];
            const lines = text.split('\n');
            
            let currentCourseCode = '';
            let currentCourseName = '';
            let currentGroupCode = ''; // Full group code like "L01_L02"
            let isValidGroup = false; // Whether current group matches campus filter
            
            console.log('Parsing preview input...');
            console.log('Total lines:', lines.length);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                if (!trimmedLine) continue;
                
                // Stop parsing if we hit the registered courses section
                if (trimmedLine.includes('Danh s√°ch m√¥n h·ªçc ƒë√£ ƒëƒÉng k√Ω') || 
                    trimmedLine.includes('M√¥n h·ªçc ƒë√£ ƒëƒÉng k√Ω') ||
                    trimmedLine.includes('Danh s√°ch ƒë√£ ƒëƒÉng k√Ω') ||
                    trimmedLine.includes('STT	M√£ MH')) {
                    console.log('üõë Hit registered courses section, stopping preview parse');
                    break;
                }
                
                // Also detect registered course format: "1ME4625 - K·ªπ nƒÉng l√£nh ƒë·∫°o3.0"
                const registeredCourseMatch = trimmedLine.match(/^(\d+)([A-Z]{2}\d{4})\s*-\s*(.+?)(\d+\.?\d*)$/);
                if (registeredCourseMatch) {
                    console.log('üõë Detected registered course format, resetting:', trimmedLine.substring(0, 40));
                    currentCourseCode = '';
                    currentCourseName = '';
                    currentGroupCode = '';
                    isValidGroup = false;
                    continue;
                }
                
                // Match course header: "CO3093 - M·∫°ng m√°y t√≠nh"
                const courseHeaderMatch = trimmedLine.match(/^([A-Z]{2}\d{4})\s*-\s*(.+)$/);
                if (courseHeaderMatch) {
                    currentCourseCode = courseHeaderMatch[1];
                    currentCourseName = courseHeaderMatch[2].trim();
                    console.log('Found preview course:', currentCourseCode, currentCourseName);
                    currentGroupCode = '';
                    isValidGroup = false;
                    continue;
                }
                
                // Skip header line "Th·ª©	Ti·∫øt	Ph√≤ng..."
                if (trimmedLine.includes('Ti·∫øt') && trimmedLine.includes('Ph√≤ng') && trimmedLine.includes('Tu·∫ßn h·ªçc')) {
                    continue;
                }
                
                // Skip table header line "Nh√≥m l·ªõp	DK/ Sƒ© s·ªë..."
                if (trimmedLine.includes('Nh√≥m l·ªõp') && trimmedLine.includes('Sƒ© s·ªë')) {
                    continue;
                }
                
                // Match group line: L01_L01, CC01_CC02, L01, CC01, A01_A01, etc.
                // Format: GroupCode + Tab + DK/Sƒ© s·ªë info
                // Group can be with underscore (L01_L02) or without (L01)
                const groupMatch = trimmedLine.match(/^([A-Z]\d{2}(?:_[A-Z0-9]+)?)\t/);
                if (groupMatch && currentCourseCode) {
                    currentGroupCode = groupMatch[1];
                    
                    // Check campus filter based on the FIRST part (LT group)
                    // CS2: starts with L or D
                    // CS1: starts with CC, CH, A, or others
                    const ltGroup = currentGroupCode.split('_')[0];
                    const isCS2 = /^(L\d|D\d)/.test(ltGroup);
                    
                    if ((campusFilter === 'cs2' && isCS2) || (campusFilter === 'cs1' && !isCS2)) {
                        isValidGroup = true;
                        console.log('‚úÖ Found valid group:', currentGroupCode, 'for campus:', campusFilter);
                    } else {
                        isValidGroup = false;
                        console.log('‚è≠Ô∏è Skipping group:', currentGroupCode, '(not matching campus filter)');
                    }
                    continue;
                }
                
                // Match schedule line for current group
                // Only process if we have a valid group
                if (currentCourseCode && currentGroupCode && isValidGroup) {
                    const firstPart = trimmedLine.split('\t')[0].trim();
                    
                    // Check if this is a schedule line (starts with day)
                    let day = '';
                    
                    // Skip "Ch∆∞a bi·∫øt"
                    if (firstPart.startsWith('Ch∆∞a') || firstPart.includes('Ch∆∞a')) {
                        console.log('Skipping Ch∆∞a bi·∫øt');
                        continue;
                    }
                    
                    // Check for "Th·ª© X"
                    if (firstPart.charCodeAt(0) === 84 || firstPart.includes('Th')) {
                        const digitMatch = firstPart.match(/[2-7]/);
                        if (digitMatch) {
                            day = 'Th·ª© ' + digitMatch[0];
                        }
                    }
                    // Check for CN
                    else if (firstPart === 'CN' || firstPart.startsWith('CN')) {
                        day = 'CN';
                    }
                    
                    if (day) {
                        // Extract periods and room
                        const parts = trimmedLine.split('\t');
                        let periods = [];
                        let room = '';
                        
                        if (parts.length >= 2) {
                            const periodStr = parts[1] || '';
                            const periodParts = periodStr.trim().split(/\s+/);
                            
                            periodParts.forEach((p) => {
                                const periodNum = parseInt(p);
                                if (!isNaN(periodNum) && periodNum > 0 && periodNum <= 17) {
                                    periods.push(periodNum);
                                }
                            });
                            
                            if (parts[2]) {
                                room = parts[2].trim();
                            }
                        }
                        
                        // Add to list if valid
                        if (day && periods.length > 0) {
                            const entry = {
                                code: currentCourseCode,
                                name: currentCourseName,
                                group: currentGroupCode,
                                day: day,
                                periods: periods,
                                room: room,
                                isPreview: true
                            };
                            previewCourses.push(entry);
                            console.log('‚úÖ Added preview entry:', entry.code, entry.group, entry.day, entry.periods);
                        }
                    }
                }
            }
            
            console.log('Preview courses parsed:', previewCourses.length, 'entries');
            return previewCourses;
        }

        function previewCourses(campusFilter) {
            const input = document.getElementById('previewData').value;
            
            if (!input.trim()) {
                alert('Vui l√≤ng d√°n th√¥ng tin m√¥n h·ªçc mu·ªën preview!');
                return;
            }
            
            previewCoursesList = parsePreviewInput(input, campusFilter);
            
            if (previewCoursesList.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc ph√π h·ª£p v·ªõi ' + (campusFilter === 'cs2' ? 'C∆° s·ªü 2' : 'C∆° s·ªü 1'));
                return;
            }
            
            // Regenerate schedule table with preview courses
            const scheduleHtml = generateScheduleTable();
            document.getElementById('scheduleContent').innerHTML = scheduleHtml;
        }

        function clearPreview() {
            document.getElementById('previewData').value = '';
            previewCoursesList = [];
            
            // Regenerate schedule without preview
            if (courses.length > 0) {
                const scheduleHtml = generateScheduleTable();
                document.getElementById('scheduleContent').innerHTML = scheduleHtml;
            }
        }
    </script>
    </main>

    <div id="footer-placeholder"></div>
    <script src="load-components.js"></script>
</body>
</html>
