<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DKMH Previewer - Xem tr∆∞·ªõc l·ªãch h·ªçc</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#10B981', // Emerald 500
                        background: '#F3F4F6', // Gray 100
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        body {
            background-color: #F3F4F6;
            color: #1F2937;
            padding-top: 50px;
        }

        /* Input Styles */
        .modern-textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #E5E7EB;
            background-color: #F9FAFB;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            transition: all 0.2s;
            resize: vertical;
        }
        .modern-textarea:focus {
            outline: none;
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background-color: #FFFFFF;
        }

        /* Schedule Table Styles - RETRO STYLE RESTORED */
        .schedule-container {
            overflow-x: auto;
            border-radius: 0.75rem;
            border: 1px solid #E5E7EB;
            background: white;
            padding-bottom: 20px; /* Space for hover expansion */
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 4px;
            min-width: 800px;
        }

        .schedule-table th {
            /* Old Gradient Header */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            padding: 15px 10px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .schedule-table td {
            vertical-align: top;
            height: 1px;
        }

        .time-cell {
            text-align: center;
            vertical-align: middle !important;
            background: #edf2f7;
            color: #4a5568;
            font-size: 0.75rem;
            border-radius: 8px;
            padding: 4px;
            font-weight: 600;
            width: 80px;
        }

        /* Course Cell - Old Logic */
        .course-cell {
            border-radius: 10px;
            padding: 0;
            height: 100%;
            /* Critical for hover effect */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
            cursor: pointer;
        }

        /* Hover Effect - Magnify */
        .course-cell:hover {
            transform: scale(1.5);
            z-index: 100;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }

        .course-content {
            height: 100%;
            padding: 8px 5px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.3s ease;
            color: white; /* Default text color for gradients */
        }

        .course-code { font-weight: 600; font-size: 11px; margin-bottom: 2px; }
        .course-name { font-size: 10px; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .course-room { margin-top: 2px; font-size: 9px; opacity: 0.9; }
        
        /* Hover expanded info */
        .course-cell:hover .course-code { font-size: 13px; }
        .course-cell:hover .course-name { font-size: 12px; }
        .course-cell:hover .course-room { font-size: 11px; }

        .course-extra {
            display: none;
            font-size: 10px;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(255,255,255,0.3);
            text-align: left;
            width: 100%;
        }

        .course-cell:hover .course-extra {
            display: block;
        }

        /* Original Gradient Palette */
        .color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
        .color-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
        .color-7 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; }
        .color-8 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; }
        .color-9 { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); color: #333; }
        .color-10 { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); color: #333; }

        .faded .course-content { opacity: 0.5; }
        .faded:hover .course-content { opacity: 0.9; }

        /* Preview specific */
        .course-cell.preview .course-content {
            background: rgba(156, 163, 175, 0.4) !important;
            color: #374151;
            border: 1px dashed #666;
        }
        
        .course-cell.preview:hover {
            transform: none; /* No zoom for preview items to avoid mess */
            box-shadow: none;
        }

        /* Conflict Handling */
        .conflict-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            height: 100%;
            width: 100%;
        }
        
        .conflict-half {
            flex: 1;
            padding: 4px;
            border-radius: 8px;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .preview-conflict {
            background: rgba(239, 68, 68, 0.8) !important;
            color: white !important;
            position: relative;
        }
        .preview-conflict::before {
            content: '‚ö†Ô∏è';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="header-placeholder"></div>

    <div class="page-shell max-w-[1600px] mx-auto p-4 md:p-6 lg:p-8 ">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight mb-2">
                <span class="text-indigo-600">DKMH</span> Previewer
            </h1>
            <p class="text-gray-500">Xem tr∆∞·ªõc v√† s·∫Øp x·∫øp l·ªãch h·ªçc tr·ª±c quan</p>
        </header>

        <!-- LAYOUT CHANGED: 4 Columns total. 1 for Input (25%), 3 for Schedule (75%) -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-start">
            
            <!-- LEFT COLUMN: INPUTS (1 Column ~ 25%) -->
            <div class="lg:col-span-1 flex flex-col gap-6 sticky top-6">
                
                <!-- STEP 1: Registered Courses -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">1</div>
                        <h2 class="text-lg font-semibold text-gray-800">L·ªãch ƒë√£ ƒëƒÉng k√Ω</h2>
                    </div>
                    
                    <div class="mb-4">
                        <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg border border-gray-100 mb-2">
                            <span class="font-semibold">H∆∞·ªõng d·∫´n:</span> V√†o trang ƒêKMH (mybk) &rarr; Ctrl+A &rarr; Ctrl+C &rarr; D√°n v√†o d∆∞·ªõi ƒë√¢y.
                        </div>
                        <textarea id="inputData" class="modern-textarea" placeholder="D√°n n·ªôi dung to√†n trang v√†o ƒë√¢y..."></textarea>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="parseAndDisplay()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 px-4 rounded-xl transition-colors shadow-sm shadow-indigo-200">
                            Xem l·ªãch
                        </button>
                        <button onclick="clearAll()" class="px-4 py-2.5 text-gray-500 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors font-medium">
                            X√≥a
                        </button>
                    </div>
                </div>

                <!-- STEP 2: Preview Courses -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold">2</div>
                        <h2 class="text-lg font-semibold text-gray-800">Preview m√¥n m·ªõi</h2>
                    </div>

                    <div class="mb-4">
                        <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg border border-gray-100 mb-2">
                            <span class="font-semibold">M·∫πo:</span> T√¨m ki·∫øm m√¥n h·ªçc &rarr; Ctrl+A &rarr; D√°n v√†o ƒë√¢y ƒë·ªÉ xem th·ª≠ c√≥ b·ªã tr√πng kh√¥ng.
                        </div>
                        <textarea id="previewData" class="modern-textarea h-32" placeholder="D√°n n·ªôi dung trang ƒëƒÉng k√Ω m√¥n h·ªçc..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="previewCourses('cs2')" class="bg-emerald-500 hover:bg-emerald-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors shadow-sm shadow-emerald-200">
                            + C∆° s·ªü 2
                        </button>
                        <button onclick="previewCourses('cs1')" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors shadow-sm shadow-orange-200">
                            + C∆° s·ªü 1
                        </button>
                    </div>
                    <button onclick="clearPreview()" class="w-full py-2 text-sm text-gray-400 hover:text-gray-600 transition-colors">
                        X√≥a preview
                    </button>
                </div>

                <!-- Footer Credit (moved from bottom) -->
                <div class="text-center text-xs text-gray-400 mt-4">
                </div>
            </div>

            <!-- RIGHT COLUMN: SCHEDULE (3 Columns ~ 75%) -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 min-h-[600px]">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <span>üìÖ</span> Th·ªùi kh√≥a bi·ªÉu
                        </h2>
                        <div class="flex gap-2 text-xs">
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-indigo-100 border border-indigo-300"></span> ƒê√£ ƒêK</div>
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-200 border-2 border-dashed border-gray-400"></span> Preview</div>
                        </div>
                    </div>

                    <div id="scheduleSection">
                        <div id="scheduleContent">
                            <!-- Empty State -->
                            <div class="flex flex-col items-center justify-center h-96 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
                                <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <p class="text-lg font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                                <p class="text-sm">H√£y th·ª±c hi·ªán B∆∞·ªõc 1 ·ªü c·ªôt b√™n tr√°i</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>
    <script src="load-components.js"></script>

    <!-- MAIN LOGIC SCRIPT (KEPT UNTOUCHED AS REQUESTED) -->
    <script>
        // Time period mapping
        const periodTimes = {
            1: { start: '06:00', end: '06:50' },
            2: { start: '07:00', end: '07:50' },
            3: { start: '08:00', end: '08:50' },
            4: { start: '09:00', end: '09:50' },
            5: { start: '10:00', end: '10:50' },
            6: { start: '11:00', end: '11:50' },
            7: { start: '12:00', end: '12:50' },
            8: { start: '13:00', end: '13:50' },
            9: { start: '14:00', end: '14:50' },
            10: { start: '15:00', end: '15:50' },
            11: { start: '16:00', end: '16:50' },
            12: { start: '17:00', end: '17:50' },
            13: { start: '18:00', end: '18:50' },
            14: { start: '18:50', end: '19:40' },
            15: { start: '19:40', end: '20:30' },
            16: { start: '20:30', end: '21:20' },
            17: { start: '21:20', end: '22:10' }
        };

        // Day mapping
        const dayMapping = {
            'Th·ª© 2': 0,
            'Th·ª© 3': 1,
            'Th·ª© 4': 2,
            'Th·ª© 5': 3,
            'Th·ª© 6': 4,
            'Th·ª© 7': 5,
            'Ch·ªß Nh·∫≠t': 6,
            'CN': 6
        };

        // Function to normalize day string
        function normalizeDay(day) {
            if (!day) return null;
            // Remove extra spaces and normalize
            const normalized = day.replace(/\s+/g, ' ').trim();
            // Try direct match first
            if (dayMapping[normalized] !== undefined) {
                return normalized;
            }
            // Try matching "Th·ª© X" pattern
            const match = normalized.match(/Th·ª©\s*(\d)/i);
            if (match) {
                return 'Th·ª© ' + match[1];
            }
            return normalized;
        }

        function getDayIndex(day) {
            const normalized = normalizeDay(day);
            return dayMapping[normalized];
        }

        const dayNames = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'CN'];

        let courses = [];

        function parseInput(text) {
            courses = [];
            
            const lines = text.split('\n');
            let currentCourseBase = null; // Base course info (code, name, credits)
            let currentGroup = ''; // Current group (e.g., "L01" or "L01_L02")
            let currentInstructor = '';
            let waitingForSchedule = false;
            
            console.log('Total lines:', lines.length);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Skip empty lines
                if (!trimmedLine) continue;
                
                // Match course header: "1ME4625 - K·ªπ nƒÉng l√£nh ƒë·∫°o3.0"
                const courseMatch = trimmedLine.match(/^(\d+)([A-Z]{2}\d{4})\s*-\s*(.+?)(\d+\.?\d*)$/);
                
                if (courseMatch) {
                    console.log('Found course:', courseMatch[2], courseMatch[3]);
                    currentCourseBase = {
                        index: parseInt(courseMatch[1]),
                        code: courseMatch[2],
                        name: courseMatch[3].trim(),
                        credits: parseFloat(courseMatch[4])
                    };
                    currentGroup = '';
                    currentInstructor = '';
                    waitingForSchedule = false;
                    continue;
                }
                
                // Match group line (L01, CH01, or combined L01_L02, CC01_CC02)
                if (currentCourseBase && /^(L\d+|CH\d+|CC\d+)(_[A-Z0-9]+)?[\t\s]/.test(trimmedLine)) {
                    const groupMatch = trimmedLine.match(/^(L\d+|CH\d+|CC\d+)(_[A-Z0-9]+)?/);
                    if (groupMatch) {
                        currentGroup = groupMatch[0]; // Full group like "L01_L02"
                        console.log('Found group:', currentGroup);
                    }
                    
                    // Check for instructor in same line
                    const instructorMatch = trimmedLine.match(/"([^"]+)"/);
                    if (instructorMatch) {
                        currentInstructor = instructorMatch[1];
                    } else {
                        currentInstructor = '';
                    }
                    
                    waitingForSchedule = true;
                    continue;
                }
                
                // Skip header line "Th·ª©    Ti·∫øt    Ph√≤ng..."
                if (trimmedLine.includes('Ti·∫øt') && trimmedLine.includes('Ph√≤ng') && trimmedLine.includes('Tu·∫ßn h·ªçc')) {
                    console.log('Skipping header line');
                    continue;
                }
                
                // Check if this is a schedule line
                const firstPart = trimmedLine.split('\t')[0].trim();
                const hasRoom = /[HBAC]\d+-\d+|DHQG/.test(trimmedLine);
                
                // Match schedule line - check if starts with day name
                const isDayLine = (
                    firstPart.charCodeAt(0) === 84 || // 'T' for Th·ª©
                    firstPart === 'CN' ||
                    firstPart.startsWith('Ch∆∞a')
                );
                
                if (currentCourseBase && currentGroup && (isDayLine || hasRoom) && !trimmedLine.includes('Tu·∫ßn h·ªçc')) {
                    console.log('>>> Schedule line detected:', trimmedLine.substring(0, 80));
                    
                    // Extract day
                    let day = '';
                    
                    // Check for "Ch∆∞a bi·∫øt"
                    if (firstPart.startsWith('Ch∆∞a') || firstPart.includes('Ch∆∞a')) {
                        day = 'Ch∆∞a bi·∫øt';
                    }
                    // Check for "Th·ª© X"
                    else if (firstPart.charCodeAt(0) === 84 || firstPart.includes('Th')) {
                        const digitMatch = firstPart.match(/[2-7]/);
                        if (digitMatch) {
                            day = 'Th·ª© ' + digitMatch[0];
                        }
                    }
                    // Check for CN
                    else if (firstPart === 'CN' || firstPart.startsWith('CN')) {
                        day = 'CN';
                    }
                    
                    console.log('Extracted day:', day);
                    
                    // Skip if "Ch∆∞a bi·∫øt"
                    if (day === 'Ch∆∞a bi·∫øt' || !day) {
                        continue;
                    }
                    
                    // Extract periods and room from the line
                    const parts = trimmedLine.split('\t');
                    let periods = [];
                    let room = '';
                    let campus = '';
                    
                    if (parts.length >= 2) {
                        const periodStr = parts[1] || '';
                        const periodParts = periodStr.trim().split(/\s+/);
                        
                        periodParts.forEach((p) => {
                            const periodNum = parseInt(p);
                            if (!isNaN(periodNum) && periodNum > 0 && periodNum <= 17) {
                                periods.push(periodNum);
                            }
                        });
                        
                        if (parts[2]) {
                            room = parts[2].trim();
                        }
                        if (parts[3]) {
                            campus = parts[3].trim();
                        }
                    }
                    
                    // Create a new course entry for this schedule line
                    if (day && periods.length > 0) {
                        const courseEntry = {
                            index: currentCourseBase.index,
                            code: currentCourseBase.code,
                            name: currentCourseBase.name,
                            credits: currentCourseBase.credits,
                            group: currentGroup,
                            instructor: currentInstructor,
                            day: day,
                            periods: periods,
                            room: room,
                            campus: campus
                        };
                        courses.push(courseEntry);
                        console.log('‚úÖ Added course entry:', courseEntry.code, courseEntry.group, courseEntry.day, courseEntry.periods);
                    }
                }
            }
            
            console.log('Parsed courses:', courses);
            
            return courses;
        }

        function getTimeRange(periods) {
            if (periods.length === 0) return '';
            
            const sortedPeriods = [...periods].sort((a, b) => a - b);
            const startPeriod = sortedPeriods[0];
            const endPeriod = sortedPeriods[sortedPeriods.length - 1];
            
            const startTime = periodTimes[startPeriod]?.start || '';
            const endTime = periodTimes[endPeriod]?.end || '';
            
            return `${startTime} - ${endTime}`;
        }

        function generateScheduleTable() {
            if (courses.length === 0) {
                return `
                    <div class="flex flex-col items-center justify-center h-96 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
                        <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-lg font-medium">Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc n√†o</p>
                        <p class="text-sm">Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu ƒë·∫ßu v√†o.</p>
                    </div>
                `;
            }

            // Create schedule grid
            // Find min and max periods
            let minPeriod = 16, maxPeriod = 1;
            courses.forEach(c => {
                c.periods.forEach(p => {
                    if (p < minPeriod) minPeriod = p;
                    if (p > maxPeriod) maxPeriod = p;
                });
            });
            
            // Also check preview courses for min/max
            previewCoursesList.forEach(c => {
                c.periods.forEach(p => {
                    if (p < minPeriod) minPeriod = p;
                    if (p > maxPeriod) maxPeriod = p;
                });
            });

            // Adjust min/max for better view if range is small
            if (minPeriod > 1) minPeriod = Math.max(1, minPeriod - 1);
            if (maxPeriod < 12) maxPeriod = Math.min(12, maxPeriod + 1);

            // Build the table
            let html = `<div class="schedule-container animate-fade-in"><table class="schedule-table">
                <thead>
                    <tr>
                        <th>Ti·∫øt/Gi·ªù</th>
                        ${dayNames.map(d => `<th>${d}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>`;

            // Create a grid to track which cells are occupied
            const grid = {};
            const cellSpans = {};
            const conflicts = []; // Track conflicts for logging

            // Add main courses to grid
            courses.forEach((course, courseIdx) => {
                const dayIdx = getDayIndex(course.day);
                if (dayIdx === undefined) {
                    console.log('Invalid day:', course.day, 'for course:', course.code);
                    return;
                }

                const sortedPeriods = [...course.periods].sort((a, b) => a - b);
                const startPeriod = sortedPeriods[0];
                const rowspan = sortedPeriods.length;

                // Mark the starting cell
                const key = `${startPeriod}-${dayIdx}`;
                grid[key] = {
                    course: course,
                    colorIdx: (courseIdx % 10) + 1,
                    rowspan: rowspan,
                    isPreview: false,
                    conflicts: [] // Array to hold conflicting courses
                };

                // Mark other cells as occupied (to skip them)
                for (let i = 1; i < sortedPeriods.length; i++) {
                    const skipKey = `${sortedPeriods[i]}-${dayIdx}`;
                    cellSpans[skipKey] = { parentKey: key };
                }
            });

            // Add preview courses to grid (handle conflicts)
            previewCoursesList.forEach((course) => {
                const dayIdx = getDayIndex(course.day);
                if (dayIdx === undefined) {
                    console.log('Invalid day for preview:', course.day, 'for course:', course.code);
                    return;
                }

                const sortedPeriods = [...course.periods].sort((a, b) => a - b);
                const startPeriod = sortedPeriods[0];
                const rowspan = sortedPeriods.length;

                // Check if any cell in this range is already occupied
                let conflictingCourse = null;
                let conflictKey = null;
                let conflictIsPreview = false;
                for (let p of sortedPeriods) {
                    const checkKey = `${p}-${dayIdx}`;
                    if (grid[checkKey]) {
                        conflictingCourse = grid[checkKey].course;
                        conflictKey = checkKey;
                        conflictIsPreview = grid[checkKey].isPreview;
                        break;
                    }
                    if (cellSpans[checkKey]) {
                        // Find the parent cell
                        const parentKey = cellSpans[checkKey].parentKey;
                        if (grid[parentKey]) {
                            conflictingCourse = grid[parentKey].course;
                            conflictKey = parentKey;
                            conflictIsPreview = grid[parentKey].isPreview;
                            break;
                        }
                    }
                }

                if (conflictingCourse) {
                    // There's a conflict!
                    const conflictType = conflictIsPreview ? 'preview-preview' : 'preview-registered';
                    
                    // Add isPreview property to conflictWith for display
                    const conflictInfo = {
                        previewCourse: course,
                        conflictWith: { ...conflictingCourse, isPreview: conflictIsPreview },
                        type: conflictType
                    };
                    conflicts.push(conflictInfo);
                    
                    // Add this preview course to the existing cell's conflicts
                    if (grid[conflictKey]) {
                        grid[conflictKey].conflicts.push({
                            course: course,
                            isPreview: true
                        });
                    }
                    
                    console.log(`‚ö†Ô∏è Conflict: Preview "${course.code} - ${course.group}" conflicts with "${conflictingCourse.code}"`);
                } else {
                    // No conflict, place normally
                    const key = `${startPeriod}-${dayIdx}`;
                    grid[key] = {
                        course: course,
                        colorIdx: 0, // Preview uses special color
                        rowspan: rowspan,
                        isPreview: true,
                        conflicts: []
                    };

                    // Mark other cells as occupied (to skip them)
                    for (let i = 1; i < sortedPeriods.length; i++) {
                        const skipKey = `${sortedPeriods[i]}-${dayIdx}`;
                        cellSpans[skipKey] = { parentKey: key };
                    }
                }
            });
            
            // Store conflicts globally for display
            window.currentConflicts = conflicts;

            // Generate rows
            for (let period = minPeriod; period <= maxPeriod; period++) {
                const time = periodTimes[period];
                html += `<tr>
                    <td class="time-cell">
                        <div class="text-xs font-bold text-gray-700">Ti·∫øt ${period}</div>
                        <div class="text-[10px] text-gray-500">${time.start}</div>
                        <div class="text-[10px] text-gray-500">${time.end}</div>
                    </td>`;

                for (let day = 0; day < 7; day++) {
                    const key = `${period}-${day}`;
                    
                    // Skip if this cell is part of a rowspan
                    if (cellSpans[key]) {
                        continue;
                    }

                    if (grid[key]) {
                        const cell = grid[key];
                        const course = cell.course;
                        const timeRange = getTimeRange(course.periods);
                        
                        // Check if there are conflicts
                        if (cell.conflicts && cell.conflicts.length > 0) {
                            // Render conflict cell - split display
                            html += `
                                <td class="course-cell conflict-cell" rowspan="${cell.rowspan}">
                                    <div class="conflict-container">`;
                            
                            // First half - the original course
                            if (cell.isPreview) {
                                html += `
                                        <div class="conflict-half bg-gray-200 text-gray-700 border border-gray-300 border-dashed">
                                            <div class="course-code">${course.code}</div>
                                            <div class="course-name">${course.group}</div>
                                        </div>`;
                            } else {
                                const isFaded = course.name.includes('Sinh ho·∫°t sinh vi√™n') ? 'faded' : '';
                                html += `
                                        <div class="conflict-half color-${cell.colorIdx} ${isFaded}">
                                            <div class="course-code">${course.code}</div>
                                            <div class="course-name">${course.name}</div>
                                        </div>`;
                            }
                            
                            // Second half - conflicting course(s) with warning style
                            cell.conflicts.forEach(conflict => {
                                const conflictCourse = conflict.course;
                                html += `
                                        <div class="conflict-half preview-conflict">
                                            <div class="course-code">${conflictCourse.code}</div>
                                            <div class="course-name">${conflictCourse.group}</div>
                                        </div>`;
                            });
                            
                            html += `
                                    </div>
                                </td>`;
                        } else if (cell.isPreview) {
                            // Preview course - simplified display
                            html += `
                                <td class="course-cell preview" rowspan="${cell.rowspan}">
                                    <div class="course-content">
                                        <div class="course-code text-gray-600">${course.code}</div>
                                        <div class="course-name text-gray-500">${course.group}</div>
                                        <div class="course-extra">
                                            <div>‚è∞ ${timeRange}</div>
                                            <div>üìç ${course.room}</div>
                                        </div>
                                    </div>
                                </td>`;
                        } else {
                            // Regular course
                            const isFaded = course.name.includes('Sinh ho·∫°t sinh vi√™n') ? 'faded' : '';
                            html += `
                                <td class="course-cell ${isFaded}" rowspan="${cell.rowspan}">
                                    <div class="course-content color-${cell.colorIdx}">
                                        <div class="course-code">${course.code}</div>
                                        <div class="course-name">${course.name}</div>
                                        <div class="course-room">üìç ${course.room}</div>
                                        <div class="course-extra">
                                            <div class="flex items-center gap-1">‚è∞ ${timeRange}</div>
                                            <div class="flex items-center gap-1">üìö ${course.credits} TC</div>
                                            <div class="flex items-center gap-1">üë• Nh√≥m: ${course.group}</div>
                                            ${course.instructor ? `<div class="flex items-center gap-1">üë®‚Äçüè´ ${course.instructor}</div>` : ''}
                                        </div>
                                    </div>
                                </td>`;
                        }
                    } else {
                        html += `<td></td>`;
                    }
                }

                html += `</tr>`;
            }

            html += `</tbody></table></div>`;

            // Summary Stats
            const totalCredits = courses.reduce((sum, c) => sum + c.credits, 0);
            html += `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-indigo-800">
                        <div class="text-xs text-indigo-400 font-semibold uppercase tracking-wider">T·ªïng m√¥n</div>
                        <div class="text-2xl font-bold">${courses.length}</div>
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-emerald-800">
                        <div class="text-xs text-emerald-400 font-semibold uppercase tracking-wider">T·ªïng t√≠n ch·ªâ</div>
                        <div class="text-2xl font-bold">${totalCredits}</div>
                    </div>
                </div>
            `;
            
            // Conflict log - show if there are any conflicts
            if (conflicts.length > 0) {
                html += `
                    <div class="mt-6 bg-red-50 border border-red-200 rounded-xl p-4 animate-fade-in">
                        <h4 class="text-red-700 font-bold flex items-center gap-2 mb-2">
                            <span>‚ö†Ô∏è</span> Ph√°t hi·ªán tr√πng l·ªãch (${conflicts.length})
                        </h4>
                        <ul class="list-disc list-inside text-sm text-red-600 space-y-1">
                            ${conflicts.map(c => {
                                const previewInfo = `${c.previewCourse.code} - ${c.previewCourse.group}`;
                                const conflictInfo = c.conflictWith.isPreview 
                                    ? `${c.conflictWith.code} - ${c.conflictWith.group}` 
                                    : `${c.conflictWith.code} - ${c.conflictWith.name}`;
                                return `<li>M√¥n preview <strong>"${previewInfo}"</strong> tr√πng v·ªõi <strong>"${conflictInfo}"</strong></li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
            }

            // Course list (Redesigned)
            html += `
                <div class="mt-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Danh s√°ch chi ti·∫øt</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${courses.map((course, idx) => `
                        <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-start gap-3 hover:shadow-md transition-shadow">
                            <div class="w-2 h-full rounded-full color-${(idx % 10) + 1} bg-current self-stretch"></div>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-sm text-gray-800 truncate">${course.code} - ${course.name}</div>
                                <div class="text-xs text-gray-500 mt-1 space-y-0.5">
                                    <div class="flex justify-between">
                                        <span>${course.day}, Ti·∫øt ${course.periods.join(', ')}</span>
                                        <span class="font-medium bg-gray-100 px-1.5 rounded text-gray-600">P. ${course.room}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Nh√≥m ${course.group}</span>
                                        <span>${course.credits} TC</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                </div>
            `;

            return html;
        }

        function parseAndDisplay() {
            const input = document.getElementById('inputData').value;
            
            if (!input.trim()) {
                alert('Vui l√≤ng d√°n th√¥ng tin t·ª´ trang ƒëƒÉng k√Ω m√¥n h·ªçc!');
                return;
            }

            parseInput(input);
            const scheduleHtml = generateScheduleTable();
            document.getElementById('scheduleContent').innerHTML = scheduleHtml;
        }

        function clearAll() {
            document.getElementById('inputData').value = '';
            courses = [];
            document.getElementById('scheduleContent').innerHTML = `
                <div class="flex flex-col items-center justify-center h-96 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
                    <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-lg font-medium">ƒê√£ x√≥a d·ªØ li·ªáu</p>
                    <p class="text-sm">H√£y b·∫Øt ƒë·∫ßu l·∫°i t·ª´ B∆∞·ªõc 1</p>
                </div>
            `;
        }

        // ============ TASK 2: Preview new courses ============
        let previewCoursesList = [];

        function parsePreviewInput(text, campusFilter) {
            const previewCourses = [];
            const lines = text.split('\n');
            
            let currentCourseCode = '';
            let currentCourseName = '';
            let currentGroupCode = ''; // Full group code like "L01_L02"
            let isValidGroup = false; // Whether current group matches campus filter
            
            console.log('Parsing preview input...');
            console.log('Total lines:', lines.length);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                if (!trimmedLine) continue;
                
                // Stop parsing if we hit the registered courses section
                if (trimmedLine.includes('Danh s√°ch m√¥n h·ªçc ƒë√£ ƒëƒÉng k√Ω') || 
                    trimmedLine.includes('M√¥n h·ªçc ƒë√£ ƒëƒÉng k√Ω') ||
                    trimmedLine.includes('Danh s√°ch ƒë√£ ƒëƒÉng k√Ω') ||
                    trimmedLine.includes('STT    M√£ MH')) {
                    console.log('üõë Hit registered courses section, stopping preview parse');
                    break;
                }
                
                // Also detect registered course format: "1ME4625 - K·ªπ nƒÉng l√£nh ƒë·∫°o3.0"
                const registeredCourseMatch = trimmedLine.match(/^(\d+)([A-Z]{2}\d{4})\s*-\s*(.+?)(\d+\.?\d*)$/);
                if (registeredCourseMatch) {
                    console.log('üõë Detected registered course format, resetting:', trimmedLine.substring(0, 40));
                    currentCourseCode = '';
                    currentCourseName = '';
                    currentGroupCode = '';
                    isValidGroup = false;
                    continue;
                }
                
                // Match course header: "CO3093 - M·∫°ng m√°y t√≠nh"
                const courseHeaderMatch = trimmedLine.match(/^([A-Z]{2}\d{4})\s*-\s*(.+)$/);
                if (courseHeaderMatch) {
                    currentCourseCode = courseHeaderMatch[1];
                    currentCourseName = courseHeaderMatch[2].trim();
                    console.log('Found preview course:', currentCourseCode, currentCourseName);
                    currentGroupCode = '';
                    isValidGroup = false;
                    continue;
                }
                
                // Skip header line "Th·ª©    Ti·∫øt    Ph√≤ng..."
                if (trimmedLine.includes('Ti·∫øt') && trimmedLine.includes('Ph√≤ng') && trimmedLine.includes('Tu·∫ßn h·ªçc')) {
                    continue;
                }
                
                // Skip table header line "Nh√≥m l·ªõp DK/ Sƒ© s·ªë..."
                if (trimmedLine.includes('Nh√≥m l·ªõp') && trimmedLine.includes('Sƒ© s·ªë')) {
                    continue;
                }
                
                // Match group line: L01_L01, CC01_CC02, L01, CC01, A01_A01, etc.
                const groupMatch = trimmedLine.match(/^([A-Z]\d{2}(?:_[A-Z0-9]+)?)\t/);
                if (groupMatch && currentCourseCode) {
                    currentGroupCode = groupMatch[1];
                    
                    // Check campus filter based on the FIRST part (LT group)
                    const ltGroup = currentGroupCode.split('_')[0];
                    const isCS2 = /^(L\d|D\d)/.test(ltGroup);
                    
                    if ((campusFilter === 'cs2' && isCS2) || (campusFilter === 'cs1' && !isCS2)) {
                        isValidGroup = true;
                        console.log('‚úÖ Found valid group:', currentGroupCode, 'for campus:', campusFilter);
                    } else {
                        isValidGroup = false;
                        console.log('‚è≠Ô∏è Skipping group:', currentGroupCode, '(not matching campus filter)');
                    }
                    continue;
                }
                
                // Match schedule line for current group
                if (currentCourseCode && currentGroupCode && isValidGroup) {
                    const firstPart = trimmedLine.split('\t')[0].trim();
                    
                    // Check if this is a schedule line (starts with day)
                    let day = '';
                    
                    // Skip "Ch∆∞a bi·∫øt"
                    if (firstPart.startsWith('Ch∆∞a') || firstPart.includes('Ch∆∞a')) {
                        console.log('Skipping Ch∆∞a bi·∫øt');
                        continue;
                    }
                    
                    // Check for "Th·ª© X"
                    if (firstPart.charCodeAt(0) === 84 || firstPart.includes('Th')) {
                        const digitMatch = firstPart.match(/[2-7]/);
                        if (digitMatch) {
                            day = 'Th·ª© ' + digitMatch[0];
                        }
                    }
                    // Check for CN
                    else if (firstPart === 'CN' || firstPart.startsWith('CN')) {
                        day = 'CN';
                    }
                    
                    if (day) {
                        // Extract periods and room
                        const parts = trimmedLine.split('\t');
                        let periods = [];
                        let room = '';
                        
                        if (parts.length >= 2) {
                            const periodStr = parts[1] || '';
                            const periodParts = periodStr.trim().split(/\s+/);
                            
                            periodParts.forEach((p) => {
                                const periodNum = parseInt(p);
                                if (!isNaN(periodNum) && periodNum > 0 && periodNum <= 17) {
                                    periods.push(periodNum);
                                }
                            });
                            
                            if (parts[2]) {
                                room = parts[2].trim();
                            }
                        }
                        
                        // Add to list if valid
                        if (day && periods.length > 0) {
                            const entry = {
                                code: currentCourseCode,
                                name: currentCourseName,
                                group: currentGroupCode,
                                day: day,
                                periods: periods,
                                room: room,
                                isPreview: true
                            };
                            previewCourses.push(entry);
                            console.log('‚úÖ Added preview entry:', entry.code, entry.group, entry.day, entry.periods);
                        }
                    }
                }
            }
            
            console.log('Preview courses parsed:', previewCourses.length, 'entries');
            return previewCourses;
        }

        function previewCourses(campusFilter) {
            const input = document.getElementById('previewData').value;
            
            if (!input.trim()) {
                alert('Vui l√≤ng d√°n th√¥ng tin m√¥n h·ªçc mu·ªën preview!');
                return;
            }
            
            previewCoursesList = parsePreviewInput(input, campusFilter);
            
            if (previewCoursesList.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc ph√π h·ª£p v·ªõi ' + (campusFilter === 'cs2' ? 'C∆° s·ªü 2' : 'C∆° s·ªü 1'));
                return;
            }
            
            // Regenerate schedule table with preview courses
            const scheduleHtml = generateScheduleTable();
            document.getElementById('scheduleContent').innerHTML = scheduleHtml;
        }

        function clearPreview() {
            document.getElementById('previewData').value = '';
            previewCoursesList = [];
            
            // Regenerate schedule without preview
            if (courses.length > 0) {
                const scheduleHtml = generateScheduleTable();
                document.getElementById('scheduleContent').innerHTML = scheduleHtml;
            }
        }
    </script>
</body>
</html>